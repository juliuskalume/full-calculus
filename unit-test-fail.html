<!DOCTYPE html>
<html class="dark" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="robots" content="noindex,nofollow" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="manifest" href="manifest.webmanifest" />
    <meta name="theme-color" content="#1cb0f6" />
    <link rel="apple-touch-icon" href="icons/icon-192.png" />
    <link rel="icon" type="image/png" href="icons/icon-192.png" />
    <title>Full Calculus — Test Failed</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" />

    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#1cb0f6",
              bgDark: "#0f172a",
              panelDark: "#111b2e",
              borderDark: "#314368",
              muted: "#94a3b8",
            },
            fontFamily: {
              display: ["Lexend", "sans-serif"],
            },
            borderRadius: {
              DEFAULT: "1rem",
              lg: "1.5rem",
              xl: "2rem",
              full: "9999px",
            },
            boxShadow: {
              soft: "0 10px 30px rgba(0,0,0,0.25)",
            },
          },
        },
      };
    </script>

    <style>
      body {
        font-family: "Lexend", sans-serif;
        min-height: max(884px, 100dvh);
      }
      .material-symbols-outlined {
        font-variation-settings: "FILL" 1, "wght" 600, "opsz" 24;
      }
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      .press:active {
        transform: translateY(4px);
      }
    </style>
    <script src="theme.js"></script>
    <script src="sound.js"></script>
  </head>

  <!-- lock body scroll -->
  <body class="bg-bgDark text-white overflow-hidden">
    <!-- app shell -->
    <div class="w-full max-w-none h-[100dvh] flex flex-col overflow-hidden shadow-2xl">

      <!-- header -->
      <header class="sticky top-0 z-30 bg-bgDark/95 backdrop-blur border-b border-borderDark px-4 py-3">
        <div class="flex items-center justify-between">
          <button
            type="button"
            onclick="location.href='path.html'"
            class="press p-2 rounded-xl hover:bg-white/5 transition-colors"
            aria-label="Close"
          >
            <span class="material-symbols-outlined">close</span>
          </button>

          <span class="text-sm font-extrabold uppercase tracking-wider text-muted">
            Test Complete
          </span>

          <div class="w-10"></div>
        </div>
      </header>

      <!-- scrollable content -->
      <main class="flex-1 overflow-y-auto no-scrollbar px-4 py-8 pb-safe">
        <div class="w-full flex flex-col items-center text-center">

          <!-- icon -->
          <div class="relative mb-6">
            <span class="material-symbols-outlined text-[80px] text-muted opacity-80">
              sentiment_dissatisfied
            </span>
          </div>

          <!-- title -->
          <h1 class="text-3xl font-extrabold tracking-tight mb-2">
            Not quite there yet…
          </h1>
          <p class="text-slate-400 font-medium mb-8">
            Every mistake is a step toward mastery.
          </p>

          <!-- stats -->
          <div class="w-full bg-panelDark rounded-2xl p-6 shadow-soft border border-borderDark mb-8">
            <div class="grid grid-cols-2 divide-x divide-borderDark/70">
              <div class="px-2">
                <p class="text-xs font-extrabold text-slate-400 uppercase tracking-wider mb-1">
                  Final Score
                </p>
                <p id="scoreText" class="text-2xl font-extrabold text-white">—%</p>
              </div>
              <div class="px-2">
                <p class="text-xs font-extrabold text-slate-400 uppercase tracking-wider mb-1">
                  Needs Review
                </p>
                <p id="topicsText" class="text-2xl font-extrabold text-white">— Topics</p>
              </div>
            </div>

            <div class="mt-4 pt-4 border-t border-borderDark/70">
              <p id="tipLine" class="text-sm text-slate-300 flex items-center justify-center gap-2">
                <span class="material-symbols-outlined text-orange-400">lightbulb</span>
                Review a few topics and try again.
              </p>
            </div>
          </div>

          <!-- actions -->
          <div class="w-full flex flex-col gap-4">
            <button
              id="reviewBtn"
              class="press w-full h-14 bg-primary hover:bg-primary/90 text-white rounded-2xl font-extrabold text-lg shadow-lg shadow-primary/20 transition-all active:scale-95 flex items-center justify-center gap-2"
              type="button"
            >
              <span class="material-symbols-outlined">menu_book</span>
              Review Lessons
            </button>

            <button
              id="retryBtn"
              class="press w-full h-14 bg-slate-900/20 hover:bg-slate-900/30 border border-borderDark rounded-2xl font-extrabold text-lg transition-all active:scale-95"
              type="button"
            >
              Try Again
            </button>
          </div>

          <p class="mt-6 text-sm text-slate-400 font-medium">
            Need a break?
            <button
              id="pathBtn"
              class="underline decoration-slate-400/30 hover:text-white transition-colors"
              type="button"
            >
              View learning path
            </button>
          </p>

          <div class="h-10"></div>
        </div>
      </main>
    </div>

    <!-- logic -->
    <script>
      const result = (() => {
        try {
          return JSON.parse(localStorage.getItem("fc_last_test") || "{}");
        } catch {
          return {};
        }
      })();

      const score = Number(result.score ?? 0);
      const breakdown = result.tagBreakdown || {};
      const weakTags = Object.entries(breakdown).filter((entry) => {
        const stats = entry[1] || {};
        const total = Number(stats.total || 0);
        const correct = Number(stats.correct || 0);
        if (!total) return false;
        return correct / total < 0.7;
      });
      const topics = weakTags.length || Math.max(1, Math.ceil((90 - Math.min(90, Math.max(0, score))) / 10));

      document.getElementById("scoreText").textContent = `${score}%`;
      document.getElementById("topicsText").textContent = `${topics} Topic${topics === 1 ? "" : "s"}`;

      const tipLine = document.getElementById("tipLine");
      if (weakTags.length) {
        const tagList = weakTags
          .slice(0, 3)
          .map((entry) => entry[0].replace(".", " "))
          .join(", ");
        tipLine.textContent = `Focus on: ${tagList}.`;
      } else {
        tipLine.textContent = `Review needed for ${topics} topic${topics === 1 ? "" : "s"} to pass.`;
      }

      document.getElementById("reviewBtn").addEventListener("click", () => {
        window.location.href = "notes.html";
      });

      document.getElementById("retryBtn").addEventListener("click", () => {
        window.location.href = "unit-test.html";
      });

      document.getElementById("pathBtn").addEventListener("click", () => {
        window.location.href = "path.html";
      });

      window.addEventListener("load", () => {
        if (window.FCSound?.play) FCSound.play("wrong", { volume: 0.6 });
      });
    </script>
  </body>
</html>



