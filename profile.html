<!DOCTYPE html>
<html class="light" lang="en">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#1cb0f6" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <link rel="icon" type="image/png" href="icons/icon-192.png" />
  <title>Full Calculus — Profile</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@100..900&display=swap" rel="stylesheet" />

  <!-- Material Symbols -->
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@100..700&display=swap"
    rel="stylesheet" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: "#1cb0f6",
            "background-light": "#f6f6f8",
            "background-dark": "#101622",
            "surface-light": "#ffffff",
            "surface-dark": "#1a2230",
          },
          fontFamily: {
            display: ["Lexend", "sans-serif"],
          },
          borderRadius: {
            DEFAULT: "1rem",
            lg: "2rem",
            xl: "3rem",
            full: "9999px",
          },
          boxShadow: {
            soft: "0 4px 20px -2px rgba(0,0,0,0.06)",
          },
        },
      },
    };
  </script>

  <style>
    body {
      font-family: "Lexend", sans-serif;
      min-height: max(884px, 100dvh);
    }

    .material-symbols-outlined {
      font-variation-settings: "FILL" 1, "wght" 450, "GRAD" 0, "opsz" 24;
    }

    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }

    .no-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    .press:active {
      transform: translateY(4px);
      box-shadow: none !important;
    }
  </style>
  <script src="theme.js"></script>
  </head>

<body data-step="profile"
  class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-slate-100 antialiased selection:bg-primary selection:text-white min-h-screen flex justify-center">
  <!-- Mobile shell -->
  <div
    class="relative w-full max-w-md h-[100dvh] sm:min-h-screen overflow-hidden bg-background-light dark:bg-background-dark shadow-2xl flex flex-col border-x border-slate-200/50 dark:border-slate-800/50">
    <!-- Sticky Header -->
    <header
      class="sticky top-0 z-40 flex items-center justify-between px-4 py-3 bg-background-light/90 dark:bg-background-dark/90 backdrop-blur-md border-b border-slate-200/60 dark:border-slate-800/60">
      <button id="backBtn" type="button"
        class="press flex items-center justify-center w-10 h-10 rounded-full hover:bg-slate-200 dark:hover:bg-surface-dark transition-colors"
        aria-label="Back">
        <span class="material-symbols-outlined text-slate-800 dark:text-slate-200">arrow_back</span>
      </button>

      <h2 class="text-lg font-extrabold tracking-tight">Profile</h2>

      <div class="flex items-center gap-2">

        <button id="settingsBtn" type="button"
          class="press flex items-center justify-center w-10 h-10 rounded-full hover:bg-slate-200 dark:hover:bg-surface-dark transition-colors"
          aria-label="Settings">
          <span class="material-symbols-outlined text-slate-800 dark:text-slate-200">settings</span>
        </button>
      </div>
    </header>

    <!-- Scrollable content -->
    <main class="flex-1 overflow-y-auto no-scrollbar pb-10">
      <!-- Hero -->
      <section class="flex flex-col items-center px-6 pt-4 pb-8">
        <div class="relative mb-5 group">
          <!-- Glow -->
          <div
            class="absolute -inset-1 bg-gradient-to-r from-primary to-sky-400 rounded-full blur opacity-25 group-hover:opacity-50 transition duration-700">
          </div>

          <div id="avatar"
            class="relative w-28 h-28 rounded-full bg-slate-200 border-4 border-white dark:border-background-dark shadow-xl overflow-hidden bg-cover bg-center"
            style="background-image:url('https://github.com/juliuskalume/full-calculus/blob/main/icons/icon-192.png?raw=true');">
          </div>

        </div>

        <h1 id="nameText" class="text-2xl font-extrabold text-center mb-1">Student</h1>

        <div class="flex items-center gap-1 opacity-70">
          <span class="material-symbols-outlined text-[16px]">calendar_month</span>
          <p class="text-sm font-medium" id="joinedText">Joined —</p>
        </div>

        <!-- Meta chips -->
        <div class="mt-4 flex items-center gap-2">
          <div
            class="flex items-center gap-1.5 px-3 py-1.5 bg-white dark:bg-surface-dark rounded-full border border-slate-200 dark:border-slate-700 shadow-sm">
            <span class="material-symbols-outlined text-yellow-500 text-[18px]">bolt</span>
            <span class="text-sm font-extrabold text-yellow-600 dark:text-yellow-400" id="xpChip">0</span>
            <span class="text-xs font-bold text-slate-400">XP</span>
          </div>

          <div
            class="flex items-center gap-1.5 px-3 py-1.5 bg-white dark:bg-surface-dark rounded-full border border-slate-200 dark:border-slate-700 shadow-sm">
            <span class="material-symbols-outlined text-orange-500 text-[18px]">local_fire_department</span>
            <span class="text-sm font-extrabold text-orange-500" id="streakChip">0</span>
            <span class="text-xs font-bold text-slate-400">streak</span>
          </div>

          <div
            class="flex items-center gap-1.5 px-3 py-1.5 bg-white dark:bg-surface-dark rounded-full border border-slate-200 dark:border-slate-700 shadow-sm">
            <span class="material-symbols-outlined text-red-500 text-[18px]">favorite</span>
            <span class="text-sm font-extrabold text-red-500" id="livesChip">0</span>
            <span class="text-xs font-bold text-slate-400">lives</span>
          </div>
        </div>
      </section>

      <!-- Stats Grid -->
      <section class="px-4 mb-8">
        <div class="grid grid-cols-2 gap-3">
          <!-- Streak Card -->
          <div
            class="group flex flex-col p-4 bg-white dark:bg-surface-dark rounded-2xl shadow-soft hover:shadow-lg transition-all duration-300 border border-slate-100 dark:border-white/5">
            <div class="flex items-center justify-between mb-3">
              <div class="p-2 bg-orange-50 dark:bg-orange-900/20 rounded-full">
                <span class="material-symbols-outlined text-orange-500 text-[20px]">local_fire_department</span>
              </div>
            </div>
            <p class="text-sm font-semibold text-slate-500 dark:text-slate-400">Streak</p>
            <p class="text-2xl font-extrabold group-hover:text-primary transition-colors">
              <span id="streakVal">0</span>
              <span class="text-base font-normal text-slate-400">Days</span>
            </p>
          </div>

          <!-- XP Card -->
          <div
            class="group flex flex-col p-4 bg-white dark:bg-surface-dark rounded-2xl shadow-soft hover:shadow-lg transition-all duration-300 border border-slate-100 dark:border-white/5">
            <div class="flex items-center justify-between mb-3">
              <div class="p-2 bg-yellow-50 dark:bg-yellow-900/20 rounded-full">
                <span class="material-symbols-outlined text-yellow-500 text-[20px]">bolt</span>
              </div>
            </div>
            <p class="text-sm font-semibold text-slate-500 dark:text-slate-400">Total XP</p>
            <p class="text-2xl font-extrabold group-hover:text-primary transition-colors" id="xpVal">0</p>
          </div>

          <!-- Lessons Completed (wide) -->
          <div
            class="col-span-2 flex items-center justify-between p-5 bg-primary/5 dark:bg-primary/10 rounded-2xl shadow-sm border border-primary/10 dark:border-primary/20">
            <div class="flex flex-col gap-1">
              <div class="flex items-center gap-2">
                <span class="material-symbols-outlined text-primary">school</span>
                <span class="text-sm font-extrabold text-primary">Lessons Completed</span>
              </div>
              <p class="text-3xl font-extrabold text-slate-900 dark:text-white mt-1" id="lessonsVal">0</p>
            </div>

            <div class="flex items-end gap-1.5 h-12" aria-hidden="true">
              <div class="w-2 bg-primary/20 h-[40%] rounded-full"></div>
              <div class="w-2 bg-primary/30 h-[60%] rounded-full"></div>
              <div class="w-2 bg-primary/50 h-[50%] rounded-full"></div>
              <div class="w-2 bg-primary h-[90%] rounded-full"></div>
              <div class="w-2 bg-primary/80 h-[75%] rounded-full"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Achievements -->
      <section class="px-4 mb-8">
        <div class="flex items-center justify-between mb-4 px-1">
          <h3 class="text-lg font-extrabold">Achievements</h3>
        </div>

        <div class="grid grid-cols-3 gap-3" id="achievementGrid">
          <div
            class="achievement-card flex flex-col items-center gap-3 p-3 bg-white dark:bg-surface-dark rounded-2xl border border-slate-100 dark:border-white/5 shadow-soft transition"
            data-calc="c1"
            data-icon="looks_one"
          >
            <div
              class="achievement-icon flex items-center justify-center w-14 h-14 rounded-full bg-gradient-to-br from-emerald-100 to-lime-100 dark:from-emerald-900/40 dark:to-lime-900/40 border-2 border-emerald-300/40 text-emerald-700 dark:text-emerald-300 shadow-inner">
              <span class="material-symbols-outlined text-2xl">looks_one</span>
            </div>
            <span class="achievement-label text-[11px] font-extrabold text-center leading-tight">Calc I<br />Trailblazer</span>
          </div>

          <div
            class="achievement-card flex flex-col items-center gap-3 p-3 bg-white dark:bg-surface-dark rounded-2xl border border-slate-100 dark:border-white/5 shadow-soft transition"
            data-calc="c2"
            data-icon="looks_two"
          >
            <div
              class="achievement-icon flex items-center justify-center w-14 h-14 rounded-full bg-gradient-to-br from-sky-100 to-indigo-100 dark:from-sky-900/40 dark:to-indigo-900/40 border-2 border-sky-300/40 text-sky-700 dark:text-sky-300 shadow-inner">
              <span class="material-symbols-outlined text-2xl">looks_two</span>
            </div>
            <span class="achievement-label text-[11px] font-extrabold text-center leading-tight">Calc II<br />Pathfinder</span>
          </div>

          <div
            class="achievement-card flex flex-col items-center gap-3 p-3 bg-white dark:bg-surface-dark rounded-2xl border border-slate-100 dark:border-white/5 shadow-soft transition"
            data-calc="c3"
            data-icon="looks_3"
          >
            <div
              class="achievement-icon flex items-center justify-center w-14 h-14 rounded-full bg-gradient-to-br from-fuchsia-100 to-purple-100 dark:from-fuchsia-900/40 dark:to-purple-900/40 border-2 border-fuchsia-300/40 text-fuchsia-700 dark:text-fuchsia-300 shadow-inner">
              <span class="material-symbols-outlined text-2xl">looks_3</span>
            </div>
            <span class="achievement-label text-[11px] font-extrabold text-center leading-tight">Calc III<br />Voyager</span>
          </div>
        </div>
      </section>

      <!-- Friends -->
      <section class="px-4 mb-10">
        <div class="flex items-center justify-between mb-4 px-1">
          <h3 class="text-lg font-extrabold">Friends</h3>
          <button id="addFriendBtn" type="button"
            class="press flex items-center gap-1 text-primary text-sm font-extrabold bg-primary/10 px-3 py-1.5 rounded-full hover:bg-primary/20 transition-colors">
            <span class="material-symbols-outlined text-[16px]">person_add</span>
            Add
          </button>
        </div>

        <div id="friendsAuthHint"
          class="hidden mb-4 px-3 py-3 rounded-2xl bg-white dark:bg-surface-dark border border-slate-200 dark:border-slate-700 text-sm text-slate-600 dark:text-slate-300">
          Sign in to add friends and view requests.
          <button id="friendsLoginBtn" class="text-primary font-extrabold ml-2">Log in</button>
        </div>

        <div id="friendRequestsWrap" class="hidden mb-4">
          <p class="text-xs uppercase font-extrabold text-slate-400 px-1 mb-2">Requests</p>
          <div id="friendRequestsList" class="flex flex-col gap-3"></div>
        </div>

        <div id="friendsList" class="flex flex-col gap-3"></div>
        <p id="friendsEmpty" class="text-sm text-slate-500 dark:text-slate-400 px-1">
          No friends yet. Add a classmate to get started.
        </p>
      </section>
    </main>
  </div>

  <!-- Friend Finder Modal -->
  <div id="friendModal" class="fixed inset-0 z-[80] hidden">
    <div class="absolute inset-0 bg-[#141414]/60 backdrop-blur-sm" data-friend-close></div>
    <div class="absolute inset-0 flex flex-col justify-end sm:justify-center items-center px-4">
      <div
        class="w-full max-w-[440px] bg-white dark:bg-surface-dark rounded-3xl shadow-2xl overflow-hidden flex flex-col">
        <div class="flex items-center justify-between px-6 pt-6">
          <h3 class="text-lg font-extrabold">Find Friends</h3>
          <button id="friendModalClose" type="button"
            class="w-9 h-9 rounded-full flex items-center justify-center text-slate-500 hover:text-primary hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors"
            aria-label="Close">
            <span class="material-symbols-outlined text-[20px]">close</span>
          </button>
        </div>

        <div class="px-6 pb-6">
          <label class="text-xs font-bold text-slate-400">Search by name</label>
          <div class="relative mt-2">
            <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">search</span>
            <input id="friendSearchInput" type="text" placeholder="Start typing..."
              class="w-full pl-10 pr-3 py-3 rounded-2xl bg-slate-100 dark:bg-slate-900/60 text-sm font-semibold border border-transparent focus:border-primary focus:ring-0" />
          </div>
          <p id="friendSearchHint" class="text-xs text-slate-400 mt-2">
            Search for classmates already on Full Calculus.
          </p>

          <div id="friendSearchResults" class="mt-4 flex flex-col gap-3"></div>
          <p id="friendSearchEmpty" class="hidden text-xs text-slate-400 mt-3">No matches yet.</p>
          <p id="friendModalStatus" class="text-xs text-slate-500 mt-3"></p>
        </div>
      </div>
    </div>
  </div>

  <!-- Friend Detail Modal -->
  <div id="friendDetailModal" class="fixed inset-0 z-[85] hidden">
    <div class="absolute inset-0 bg-[#141414]/60 backdrop-blur-sm" data-friend-detail-close></div>
    <div class="absolute inset-0 flex flex-col justify-end sm:justify-center items-center px-4">
      <div class="w-full max-w-[460px] bg-white dark:bg-surface-dark rounded-3xl shadow-2xl overflow-hidden">
        <div class="flex items-center justify-between px-6 pt-6">
          <h3 id="friendDetailName" class="text-lg font-extrabold">Friend</h3>
          <button id="friendDetailClose" type="button"
            class="w-9 h-9 rounded-full flex items-center justify-center text-slate-500 hover:text-primary hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors"
            aria-label="Close">
            <span class="material-symbols-outlined text-[20px]">close</span>
          </button>
        </div>
        <div class="px-6 pb-6">
          <div class="flex items-center gap-4 mt-2">
            <div id="friendDetailAvatar"
              class="w-16 h-16 rounded-full bg-cover bg-center border border-slate-200 dark:border-slate-700"
              style="background-image:url('https://github.com/juliuskalume/full-calculus/blob/main/icons/icon-192.png?raw=true');">
            </div>
            <div>
              <p id="friendDetailStatus" class="text-sm font-semibold text-slate-500 dark:text-slate-400">Last seen</p>
              <p id="friendDetailJoined" class="text-xs text-slate-400">Joined â€”</p>
            </div>
          </div>

          <div class="mt-5 grid grid-cols-3 gap-2">
            <div class="rounded-2xl bg-slate-100 dark:bg-slate-900/60 p-3 text-center">
              <p class="text-[11px] uppercase font-extrabold text-slate-400">Streak</p>
              <p id="friendDetailStreak" class="text-lg font-extrabold text-orange-500">0</p>
            </div>
            <div class="rounded-2xl bg-slate-100 dark:bg-slate-900/60 p-3 text-center">
              <p class="text-[11px] uppercase font-extrabold text-slate-400">XP</p>
              <p id="friendDetailXp" class="text-lg font-extrabold text-yellow-500">0</p>
            </div>
            <div class="rounded-2xl bg-slate-100 dark:bg-slate-900/60 p-3 text-center">
              <p class="text-[11px] uppercase font-extrabold text-slate-400">Lessons</p>
              <p id="friendDetailLessons" class="text-lg font-extrabold text-primary">0</p>
            </div>
          </div>

          <div class="mt-5">
            <p class="text-xs uppercase font-extrabold text-slate-400 mb-2">Achievements</p>
            <div id="friendDetailAchievements" class="grid grid-cols-3 gap-3"></div>
            <p id="friendDetailAchievementsNote" class="text-xs text-slate-400 mt-2"></p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Content data (for achievements) -->
  <script src="content-structure.js"></script>
  <script src="content-sections.js"></script>
  <script src="content-items.js"></script>
  <script src="content-examples.js"></script>
  <script src="content-tests.js"></script>
  <script src="content.js"></script>

  <!-- Shared state -->
  <script src="state.js"></script>
  <script src="progress.js"></script>
  <script src="firebase-config.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="auth.js"></script>

  <script>
    // Navigation
    document.getElementById("backBtn")?.addEventListener("click", () => {
      window.location.href = "path.html";
    });

    // Hydrate from FC state
    (function hydrate() {
      // XP/streak/lives live in fc_meta (state.js)
      const meta = window.FC?.get ? FC.get() : { xp: 0, streak: 0, lives: 0 };

      // name/avatar live in fc_state (app.js onboarding)
      let s = {};
      try {
        s = JSON.parse(localStorage.getItem("fc_state") || "{}");
      } catch {
        s = {};
      }

      const DEFAULT_AVATAR =
        "https://github.com/juliuskalume/full-calculus/blob/main/icons/icon-192.png?raw=true";

      const name = (s.name && String(s.name).trim()) || "CalcHero";
      const avatarUrl = s.avatarUrl || DEFAULT_AVATAR;

      document.getElementById("nameText").textContent = name;

      const avatarEl = document.getElementById("avatar");
      if (avatarEl) avatarEl.style.backgroundImage = `url('${avatarUrl}')`;

      // chips/cards from meta (fc_meta)
      document.getElementById("xpChip").textContent = String(meta.xp ?? 0);
      document.getElementById("streakChip").textContent = String(meta.streak ?? 0);
      document.getElementById("livesChip").textContent = String(meta.lives ?? 0);

      document.getElementById("xpVal").textContent = String(meta.xp ?? 0);
      document.getElementById("streakVal").textContent = String(meta.streak ?? 0);

      // lessons completed (real count from progress)
      const progress = window.FCProgress?.get ? FCProgress.get() : {};
      const completedSections = Array.isArray(progress.completedSections)
        ? progress.completedSections
        : Array.isArray(progress.completed)
          ? progress.completed
          : [];
      document.getElementById("lessonsVal").textContent = String(completedSections.length);

      // achievements: unlock only after completing all units per Calc
      const allSections = Array.isArray(window.FCContent?.sections) ? window.FCContent.sections : [];
      const totals = {
        c1: allSections.filter((section) => String(section.id).startsWith("c1-")).map((s) => s.id),
        c2: allSections.filter((section) => String(section.id).startsWith("c2-")).map((s) => s.id),
        c3: allSections.filter((section) => String(section.id).startsWith("c3-")).map((s) => s.id),
      };
      const completedSet = new Set(completedSections.map((id) => String(id)));
      const calcUnlocked = {
        c1: totals.c1.length > 0 && totals.c1.every((id) => completedSet.has(id)),
        c2: totals.c2.length > 0 && totals.c2.every((id) => completedSet.has(id)),
        c3: totals.c3.length > 0 && totals.c3.every((id) => completedSet.has(id)),
      };

      document.querySelectorAll(".achievement-card").forEach((card) => {
        const key = card.dataset.calc;
        const unlocked = !!calcUnlocked[key];
        const iconWrap = card.querySelector(".achievement-icon");
        const icon = card.querySelector(".achievement-icon span");
        const iconName = card.dataset.icon || "emoji_events";

        if (unlocked) {
          card.classList.remove("opacity-60", "grayscale");
          if (icon) icon.textContent = iconName;
          if (iconWrap) {
            iconWrap.classList.remove(
              "bg-slate-100",
              "dark:bg-slate-800",
              "border-dashed",
              "border-slate-300",
              "dark:border-slate-600",
              "text-slate-400"
            );
          }
        } else {
          card.classList.add("opacity-60", "grayscale");
          if (icon) icon.textContent = "lock";
          if (iconWrap) {
            iconWrap.classList.add(
              "bg-slate-100",
              "dark:bg-slate-800",
              "border-dashed",
              "border-slate-300",
              "dark:border-slate-600",
              "text-slate-400"
            );
          }
        }
      });

      // joined date (keep your existing approach)
      const joinedKey = "fc_joined_date";
      let joined = localStorage.getItem(joinedKey);
      if (!joined) {
        joined = new Intl.DateTimeFormat("en-US", { month: "long", year: "numeric" }).format(new Date());
        localStorage.setItem(joinedKey, joined);
      }
      document.getElementById("joinedText").textContent = `Joined ${joined}`;
    })();

    document.getElementById("settingsBtn")?.addEventListener("click", () => {
      location.href = "settings.html";
    });

    (function initFriends() {
      const addBtn = document.getElementById("addFriendBtn");
      const authHint = document.getElementById("friendsAuthHint");
      const loginBtn = document.getElementById("friendsLoginBtn");
      const requestsWrap = document.getElementById("friendRequestsWrap");
      const requestsList = document.getElementById("friendRequestsList");
      const friendsList = document.getElementById("friendsList");
      const friendsEmpty = document.getElementById("friendsEmpty");

      const modal = document.getElementById("friendModal");
      const modalClose = document.getElementById("friendModalClose");
      const modalBackdrop = document.querySelector("[data-friend-close]");
      const searchInput = document.getElementById("friendSearchInput");
      const searchResults = document.getElementById("friendSearchResults");
      const searchEmpty = document.getElementById("friendSearchEmpty");
      const searchHint = document.getElementById("friendSearchHint");
      const statusEl = document.getElementById("friendModalStatus");
      const detailModal = document.getElementById("friendDetailModal");
      const detailClose = document.getElementById("friendDetailClose");
      const detailBackdrop = document.querySelector("[data-friend-detail-close]");
      const detailName = document.getElementById("friendDetailName");
      const detailAvatar = document.getElementById("friendDetailAvatar");
      const detailStatus = document.getElementById("friendDetailStatus");
      const detailJoined = document.getElementById("friendDetailJoined");
      const detailStreak = document.getElementById("friendDetailStreak");
      const detailXp = document.getElementById("friendDetailXp");
      const detailLessons = document.getElementById("friendDetailLessons");
      const detailAchievements = document.getElementById("friendDetailAchievements");
      const detailAchievementsNote = document.getElementById("friendDetailAchievementsNote");

      if (!addBtn || !authHint || !friendsList || !modal) return;

      const DEFAULT_AVATAR =
        "https://github.com/juliuskalume/full-calculus/blob/main/icons/icon-192.png?raw=true";

      let currentUser = null;
      let db = null;
      let subscriptions = [];
      let friendStateByUid = {};
      let incomingRequests = [];
      let outgoingRequests = [];
      let acceptedFriends = [];
      let lastSearchResults = [];
      let searchTimer = null;
      let profilesByUid = {};
      let profileRefreshTimer = null;

      const getLocalProfile = () => {
        try {
          return JSON.parse(localStorage.getItem("fc_state") || "{}");
        } catch {
          return {};
        }
      };

      const setStatus = (message = "", tone = "normal") => {
        if (!statusEl) return;
        statusEl.textContent = message;
        statusEl.className =
          tone === "error" ? "text-xs text-red-500 mt-3" : "text-xs text-slate-500 mt-3";
      };

      const formatLastSeen = (iso) => {
        const time = Date.parse(iso || "");
        if (Number.isNaN(time)) {
          return { label: "Last seen unavailable", online: false };
        }
        const diff = Date.now() - time;
        if (diff < 2 * 60 * 1000) {
          return { label: "Online now", online: true };
        }
        if (diff < 60 * 1000) {
          return { label: "Last seen just now", online: false };
        }
        if (diff < 60 * 60 * 1000) {
          const mins = Math.max(1, Math.round(diff / 60000));
          return { label: `Last seen ${mins}m ago`, online: false };
        }
        if (diff < 24 * 60 * 60 * 1000) {
          const hrs = Math.max(1, Math.round(diff / 3600000));
          return { label: `Last seen ${hrs}h ago`, online: false };
        }
        const days = Math.max(1, Math.round(diff / 86400000));
        return { label: `Last seen ${days}d ago`, online: false };
      };

      const formatJoined = (iso) => {
        const time = Date.parse(iso || "");
        if (Number.isNaN(time)) return "Joined —";
        return `Joined ${new Intl.DateTimeFormat("en-US", { month: "long", year: "numeric" }).format(
          new Date(time)
        )}`;
      };

      const computeAchievementsFromProfile = (profile) => {
        if (profile?.achievements && typeof profile.achievements === "object") {
          return {
            c1: !!profile.achievements.c1,
            c2: !!profile.achievements.c2,
            c3: !!profile.achievements.c3,
          };
        }
        const completed = Array.isArray(profile?.completedSections) ? profile.completedSections : null;
        const allSections = Array.isArray(window.FCContent?.sections) ? window.FCContent.sections : null;
        if (!completed || !allSections) return null;
        const totals = {
          c1: allSections.filter((section) => String(section.id).startsWith("c1-")).map((s) => s.id),
          c2: allSections.filter((section) => String(section.id).startsWith("c2-")).map((s) => s.id),
          c3: allSections.filter((section) => String(section.id).startsWith("c3-")).map((s) => s.id),
        };
        const completedSet = new Set(completed.map((id) => String(id)));
        return {
          c1: totals.c1.length > 0 && totals.c1.every((id) => completedSet.has(id)),
          c2: totals.c2.length > 0 && totals.c2.every((id) => completedSet.has(id)),
          c3: totals.c3.length > 0 && totals.c3.every((id) => completedSet.has(id)),
        };
      };

      const renderAchievementCards = (achievementState) => {
        if (!detailAchievements) return;
        const data = [
          { key: "c1", label: "Calc I", subtitle: "Trailblazer", icon: "looks_one" },
          { key: "c2", label: "Calc II", subtitle: "Pathfinder", icon: "looks_two" },
          { key: "c3", label: "Calc III", subtitle: "Voyager", icon: "looks_3" },
        ];
        detailAchievements.innerHTML = data
          .map((item) => {
            const unlocked = achievementState ? !!achievementState[item.key] : false;
            return `
              <div class="flex flex-col items-center gap-2 p-3 rounded-2xl border ${
                unlocked ? "border-primary/30 bg-primary/10" : "border-slate-200 dark:border-slate-700 bg-slate-100 dark:bg-slate-800/60"
              }">
                <span class="material-symbols-outlined ${unlocked ? "text-primary" : "text-slate-400"}">${unlocked ? item.icon : "lock"}</span>
                <span class="text-[11px] font-extrabold text-center leading-tight">
                  ${item.label}<br />${item.subtitle}
                </span>
              </div>
            `;
          })
          .join("");
      };

      const openFriendDetail = (uid) => {
        if (!detailModal) return;
        const profile = profilesByUid[uid];
        if (!profile) {
          setStatus("Friend details are still loading.", "error");
          return;
        }
        if (detailName) detailName.textContent = profile.displayName || "Learner";
        if (detailAvatar) {
          detailAvatar.style.backgroundImage = `url('${profile.photoURL || DEFAULT_AVATAR}')`;
        }
        const lastSeen = formatLastSeen(profile.lastActiveAt);
        if (detailStatus) {
          detailStatus.textContent = lastSeen.label;
          detailStatus.className = lastSeen.online
            ? "text-sm font-semibold text-emerald-500"
            : "text-sm font-semibold text-slate-500 dark:text-slate-400";
        }
        if (detailJoined) detailJoined.textContent = formatJoined(profile.joinedAt || profile.createdAt);
        if (detailStreak) detailStreak.textContent = String(profile.streak ?? 0);
        if (detailXp) detailXp.textContent = String(profile.xp ?? 0);
        if (detailLessons) detailLessons.textContent = String(profile.lessonsCompleted ?? 0);

        const achievements = computeAchievementsFromProfile(profile);
        renderAchievementCards(achievements);
        if (detailAchievementsNote) {
          detailAchievementsNote.textContent = achievements ? "" : "Achievements data not available yet.";
        }

        detailModal.classList.remove("hidden");
        document.body.classList.add("overflow-hidden");
      };

      const closeFriendDetail = () => {
        if (!detailModal) return;
        detailModal.classList.add("hidden");
        document.body.classList.remove("overflow-hidden");
      };

      const showAuth = () => {
        authHint.classList.remove("hidden");
        addBtn.setAttribute("disabled", "disabled");
        addBtn.classList.add("opacity-60", "cursor-not-allowed");
        requestsWrap.classList.add("hidden");
        requestsList.innerHTML = "";
        friendsList.innerHTML = "";
        friendsEmpty.classList.remove("hidden");
      };

      const showAuthed = () => {
        authHint.classList.add("hidden");
        addBtn.removeAttribute("disabled");
        addBtn.classList.remove("opacity-60", "cursor-not-allowed");
      };

      const openModal = () => {
        if (!currentUser) {
          window.location.href = "login.html";
          return;
        }
        modal.classList.remove("hidden");
        document.body.classList.add("overflow-hidden");
        if (searchInput) {
          searchInput.value = "";
          searchInput.focus();
        }
        if (searchResults) searchResults.innerHTML = "";
        if (searchEmpty) searchEmpty.classList.add("hidden");
        if (searchHint) searchHint.classList.remove("hidden");
        setStatus("");
      };

      const closeModal = () => {
        modal.classList.add("hidden");
        document.body.classList.remove("overflow-hidden");
      };

      addBtn.addEventListener("click", openModal);
      modalClose?.addEventListener("click", closeModal);
      modalBackdrop?.addEventListener("click", closeModal);
      detailClose?.addEventListener("click", closeFriendDetail);
      detailBackdrop?.addEventListener("click", closeFriendDetail);
      loginBtn?.addEventListener("click", () => {
        window.location.href = "login.html";
      });

      const friendDocId = (uidA, uidB) => [uidA, uidB].sort().join("__");

      const getFriendMeta = (record, uid) => {
        const isIncoming = record.to === uid;
        return {
          uid: isIncoming ? record.from : record.to,
          name: (isIncoming ? record.fromName : record.toName) || "Learner",
          photo: (isIncoming ? record.fromPhoto : record.toPhoto) || DEFAULT_AVATAR,
          incoming: isIncoming,
        };
      };

      const renderRequests = () => {
        if (!requestsList || !requestsWrap) return;
        const combined = [...incomingRequests, ...outgoingRequests];
        if (!combined.length) {
          requestsWrap.classList.add("hidden");
          requestsList.innerHTML = "";
          return;
        }
        requestsWrap.classList.remove("hidden");
        requestsList.innerHTML = combined
          .map((record) => {
            const info = getFriendMeta(record, currentUser.uid);
            const isIncoming = info.incoming;
            const actionButtons = isIncoming
              ? `
                <button data-action="accept" data-id="${record.id}" class="px-3 py-1.5 rounded-full bg-primary text-black text-xs font-bold">Accept</button>
                <button data-action="decline" data-id="${record.id}" class="px-3 py-1.5 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-500 text-xs font-bold">Decline</button>
              `
              : `
                <button data-action="cancel" data-id="${record.id}" class="px-3 py-1.5 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-500 text-xs font-bold">Cancel</button>
              `;
            return `
              <div class="flex items-center gap-3 p-3 bg-white dark:bg-surface-dark rounded-2xl border border-slate-100 dark:border-white/5 shadow-soft">
                <div class="w-12 h-12 rounded-full bg-cover bg-center border border-slate-200 dark:border-slate-700"
                  style="background-image:url('${info.photo}')"></div>
                <div class="flex-1 min-w-0">
                  <h4 class="font-extrabold text-sm truncate">${info.name}</h4>
                  <p class="text-xs text-slate-500 dark:text-slate-400 truncate mt-0.5">${isIncoming ? "Sent you a request" : "Request pending"}</p>
                </div>
                <div class="flex items-center gap-2">${actionButtons}</div>
              </div>
            `;
          })
          .join("");
      };

      const renderFriends = () => {
        if (!friendsList || !friendsEmpty) return;
        if (!acceptedFriends.length) {
          friendsList.innerHTML = "";
          friendsEmpty.classList.remove("hidden");
          return;
        }
        friendsEmpty.classList.add("hidden");
        friendsList.innerHTML = acceptedFriends
          .map((record) => {
            const info = getFriendMeta(record, currentUser.uid);
            const profile = profilesByUid[info.uid] || {};
            const presence = formatLastSeen(profile.lastActiveAt);
            const statusClass = presence.online ? "text-emerald-500" : "text-slate-500 dark:text-slate-400";
            return `
              <div data-friend-card data-uid="${info.uid}" class="flex items-center gap-3 p-3 bg-white dark:bg-surface-dark rounded-2xl border border-slate-100 dark:border-white/5 shadow-soft cursor-pointer">
                <div class="w-12 h-12 rounded-full bg-cover bg-center border border-slate-200 dark:border-slate-700"
                  style="background-image:url('${info.photo}')"></div>
                <div class="flex-1 min-w-0">
                  <h4 class="font-extrabold text-sm truncate">${info.name}</h4>
                  <p class="text-xs ${statusClass} truncate mt-0.5">${presence.label}</p>
                </div>
                <button data-action="remove" data-id="${record.id}"
                  class="px-3 py-1.5 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-500 text-xs font-bold">
                  Remove
                </button>
              </div>
            `;
          })
          .join("");
      };

      const updateFriendState = () => {
        friendStateByUid = {};
        incomingRequests.forEach((record) => {
          friendStateByUid[record.from] = { status: "incoming", id: record.id };
        });
        outgoingRequests.forEach((record) => {
          friendStateByUid[record.to] = { status: "outgoing", id: record.id };
        });
        acceptedFriends.forEach((record) => {
          const other = record.from === currentUser.uid ? record.to : record.from;
          friendStateByUid[other] = { status: "friends", id: record.id };
        });
      };

      const refreshLists = () => {
        updateFriendState();
        renderRequests();
        renderFriends();
        if (lastSearchResults.length) {
          renderSearchResults(lastSearchResults);
        }
        refreshProfiles();
      };

      const clearSubscriptions = () => {
        subscriptions.forEach((unsub) => {
          try {
            unsub();
          } catch {
            // ignore
          }
        });
        subscriptions = [];
      };

      const fetchProfiles = async (uids, force = false) => {
        if (!db || !uids.length) return;
        const unique = Array.from(new Set(uids));
        const targets = force ? unique : unique.filter((uid) => !profilesByUid[uid]);
        if (!targets.length) return;
        const chunks = [];
        while (targets.length) chunks.push(targets.splice(0, 10));
        try {
          await Promise.all(
            chunks.map(async (chunk) => {
              const snap = await db.collection("public_profiles").where("uid", "in", chunk).get();
              snap.forEach((doc) => {
                profilesByUid[doc.id] = doc.data() || {};
              });
            })
          );
          renderFriends();
        } catch (err) {
          setStatus("Could not load friend details.", "error");
        }
      };

      const refreshProfiles = async (force = false) => {
        if (!currentUser) return;
        const friendUids = acceptedFriends
          .map((record) => (record.from === currentUser.uid ? record.to : record.from))
          .filter(Boolean);
        if (!friendUids.length) return;
        await fetchProfiles(friendUids, force);
      };

      const subscribeFriends = () => {
        if (!db || !currentUser) return;
        clearSubscriptions();
        const uid = currentUser.uid;
        const toPending = db.collection("friendships").where("to", "==", uid).where("status", "==", "pending");
        const fromPending = db.collection("friendships").where("from", "==", uid).where("status", "==", "pending");
        const fromAccepted = db.collection("friendships").where("from", "==", uid).where("status", "==", "accepted");
        const toAccepted = db.collection("friendships").where("to", "==", uid).where("status", "==", "accepted");

        subscriptions.push(
          toPending.onSnapshot((snap) => {
            incomingRequests = snap.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
            refreshLists();
          })
        );
        subscriptions.push(
          fromPending.onSnapshot((snap) => {
            outgoingRequests = snap.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
            refreshLists();
          })
        );
        subscriptions.push(
          fromAccepted.onSnapshot((snap) => {
            const outgoingAccepted = snap.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
            acceptedFriends = [...outgoingAccepted, ...acceptedFriends.filter((record) => record.to === uid)];
            refreshLists();
          })
        );
        subscriptions.push(
          toAccepted.onSnapshot((snap) => {
            const incomingAccepted = snap.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
            acceptedFriends = [...acceptedFriends.filter((record) => record.from === uid), ...incomingAccepted];
            refreshLists();
          })
        );
      };

      const handleRequestAction = async (action, docId) => {
        if (!db || !docId) return;
        try {
          if (action === "accept") {
            await db.collection("friendships").doc(docId).update({
              status: "accepted",
              acceptedAt: new Date().toISOString(),
            });
            return;
          }
          if (["decline", "cancel", "remove"].includes(action)) {
            await db.collection("friendships").doc(docId).delete();
          }
        } catch (err) {
          const code = err?.code ? ` (${err.code})` : "";
          setStatus(`Could not update friend request${code}. Try again.`, "error");
        }
      };

      requestsList?.addEventListener("click", (event) => {
        const btn = event.target.closest("button[data-action]");
        if (!btn) return;
        const action = btn.getAttribute("data-action");
        const id = btn.getAttribute("data-id");
        handleRequestAction(action, id);
      });

      friendsList?.addEventListener("click", (event) => {
        const removeBtn = event.target.closest("button[data-action='remove']");
        if (removeBtn) {
          const id = removeBtn.getAttribute("data-id");
          handleRequestAction("remove", id);
          return;
        }
        const card = event.target.closest("[data-friend-card]");
        if (!card) return;
        const uid = card.getAttribute("data-uid");
        if (uid) openFriendDetail(uid);
      });

      const renderSearchResults = (items) => {
        lastSearchResults = items;
        if (!searchResults || !searchEmpty) return;
        searchResults.innerHTML = "";
        if (!items.length) {
          searchEmpty.classList.remove("hidden");
          return;
        }
        searchEmpty.classList.add("hidden");
        items.forEach((user) => {
          const state = friendStateByUid[user.uid]?.status || "";
          let label = "Add";
          let disabled = false;
          let action = "add";
          if (user.uid === currentUser.uid) {
            label = "You";
            disabled = true;
          } else if (state === "friends") {
            label = "Friends";
            disabled = true;
          } else if (state === "outgoing") {
            label = "Pending";
            disabled = true;
          } else if (state === "incoming") {
            label = "Accept";
            action = "accept";
          }

          const card = document.createElement("div");
          card.className =
            "flex items-center gap-3 p-3 rounded-2xl bg-slate-100 dark:bg-slate-900/60 border border-slate-200 dark:border-slate-800";
          card.innerHTML = `
            <div class="w-11 h-11 rounded-full bg-cover bg-center border border-slate-200 dark:border-slate-700"
              style="background-image:url('${user.photoURL || DEFAULT_AVATAR}')"></div>
            <div class="flex-1 min-w-0">
              <p class="font-extrabold text-sm truncate">${user.displayName || "Learner"}</p>
              <p class="text-xs text-slate-500 dark:text-slate-400">XP ${Number(user.xp || 0)}</p>
            </div>
            <button
              data-action="${action}"
              data-uid="${user.uid}"
              class="px-3 py-1.5 rounded-full ${disabled ? "bg-slate-200 dark:bg-slate-800 text-slate-400" : "bg-primary text-black"} text-xs font-bold"
              ${disabled ? "disabled" : ""}
            >
              ${label}
            </button>
          `;
          searchResults.appendChild(card);
        });
      };

      const searchUsers = async (query) => {
        if (!db) return;
        setStatus("Searching...");
        const q = String(query || "").trim();
        if (q.length < 2) {
          if (searchResults) searchResults.innerHTML = "";
          if (searchEmpty) searchEmpty.classList.add("hidden");
          if (searchHint) searchHint.classList.remove("hidden");
          setStatus("");
          return;
        }
        if (searchHint) searchHint.classList.add("hidden");

        const qLower = q.toLowerCase();
        const queries = [
          db.collection("leaderboard").orderBy("displayNameLower").startAt(qLower).endAt(qLower + "\uf8ff").limit(10),
          db.collection("leaderboard").orderBy("displayName").startAt(q).endAt(q + "\uf8ff").limit(10),
        ];

        try {
          const results = [];
          const seen = new Set();
          const snapshots = await Promise.allSettled(queries.map((ref) => ref.get()));
          snapshots.forEach((result) => {
            if (result.status !== "fulfilled") return;
            result.value.forEach((doc) => {
              const data = doc.data() || {};
              if (!data.uid || seen.has(data.uid)) return;
              seen.add(data.uid);
              results.push({
                uid: data.uid,
                displayName: data.displayName || "Learner",
                photoURL: data.photoURL || DEFAULT_AVATAR,
                xp: data.xp || 0,
              });
            });
          });

          const filtered = results.filter((user) => user.uid !== currentUser.uid);
          renderSearchResults(filtered);
          setStatus(filtered.length ? "" : "No matches. Try another name.");
        } catch (err) {
          setStatus("Search failed. Try again.", "error");
        }
      };

      searchInput?.addEventListener("input", (event) => {
        const value = event.target.value;
        clearTimeout(searchTimer);
        searchTimer = setTimeout(() => searchUsers(value), 300);
      });

      searchResults?.addEventListener("click", async (event) => {
        const btn = event.target.closest("button[data-action]");
        if (!btn || !currentUser || !db) return;
        const action = btn.getAttribute("data-action");
        const uid = btn.getAttribute("data-uid");
        if (!uid) return;
        if (action === "accept") {
          const existing = friendStateByUid[uid];
          if (existing?.id) await handleRequestAction("accept", existing.id);
          return;
        }
        if (action !== "add") return;

        if (uid === currentUser.uid) {
          setStatus("You cannot add yourself.", "error");
          return;
        }
        if (friendStateByUid[uid]) {
          setStatus("Request already exists.");
          return;
        }

        const docId = friendDocId(currentUser.uid, uid);
        const docRef = db.collection("friendships").doc(docId);
        try {
          const localProfile = getLocalProfile();
          const payload = {
            from: currentUser.uid,
            to: uid,
            status: "pending",
            createdAt: new Date().toISOString(),
            fromName: currentUser.displayName || localProfile.name || "Learner",
            fromPhoto: currentUser.photoURL || localProfile.avatarUrl || DEFAULT_AVATAR,
          };

          const target = lastSearchResults.find((item) => item.uid === uid);
          if (target) {
            payload.toName = target.displayName || "Learner";
            payload.toPhoto = target.photoURL || DEFAULT_AVATAR;
          }

          await docRef.set(payload);
          setStatus("Friend request sent!");
        } catch (err) {
          const code = err?.code ? ` (${err.code})` : "";
          setStatus(`Unable to send request${code}. Try again.`, "error");
        }
      });

      const ensureAuthReady = () => {
        if (!window.FCAuth || !window.FCAuth.enabled) {
          showAuth();
          return;
        }
        db = window.FCAuth.db;
        window.FCAuth.onAuthStateChanged((user) => {
          currentUser = user;
          if (!user) {
            clearSubscriptions();
            if (profileRefreshTimer) {
              clearInterval(profileRefreshTimer);
              profileRefreshTimer = null;
            }
            incomingRequests = [];
            outgoingRequests = [];
            acceptedFriends = [];
            profilesByUid = {};
            closeFriendDetail();
            refreshLists();
            showAuth();
            return;
          }
          showAuthed();
          subscribeFriends();
          refreshProfiles(true);
          if (!profileRefreshTimer) {
            profileRefreshTimer = setInterval(() => refreshProfiles(true), 120000);
          }
        });
      };

      ensureAuthReady();
    })();
  </script>

</body>

</html>



