<!DOCTYPE html>
<html class="light" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <link rel="manifest" href="manifest.webmanifest" />
    <meta name="theme-color" content="#1cb0f6" />
    <link rel="apple-touch-icon" href="icons/icon-192.png" />
    <link rel="icon" type="image/png" href="icons/icon-192.png" />
    <title>Full Calculus — Practice Hub</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

    <!-- Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />

    <!-- Material Symbols -->
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
      rel="stylesheet"
    />

    <!-- MathJax -->
    <script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <!-- Tailwind config -->
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#1cb0f6",
              "primary-hover": "#1599d4",
              secondary: "#49659c",
              "background-light": "#f5f6f8",
              "background-dark": "#101622",
              "surface-light": "#ffffff",
              "surface-dark": "#1a2332",
            },
            fontFamily: {
              display: ["Lexend", "sans-serif"],
            },
            borderRadius: {
              DEFAULT: "1rem",
              lg: "1.5rem",
              xl: "2rem",
              "2xl": "2.5rem",
              full: "9999px",
            },
            boxShadow: {
              bubbly: "0 4px 0 0 rgba(0,0,0,0.10)",
              "bubbly-primary": "0 4px 0 0 #1599d4",
            },
          },
        },
      };
    </script>

    <style>
      body {
        font-family: "Lexend", sans-serif;
        min-height: max(884px, 100dvh);
      }
      .material-symbols-outlined {
        font-variation-settings: "FILL" 1, "wght" 600, "GRAD" 0, "opsz" 24;
      }
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      .press:active {
        transform: translateY(4px);
        box-shadow: none !important;
      }
    </style>
    <script src="theme.js"></script>
  </head>

  <!-- ✅ app shell scroll strategy: lock page scroll, main scrolls -->
  <body
    data-step="practice"
    class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-slate-100 antialiased overflow-hidden"
  >
    <!-- ✅ viewport shell -->
    <div
      class="w-full max-w-md mx-auto h-[100dvh] bg-background-light dark:bg-background-dark shadow-2xl flex flex-col overflow-hidden"
    >
      <!-- Header -->
      <header
        class="sticky top-0 z-30 bg-background-light/95 dark:bg-background-dark/95 backdrop-blur-md border-b border-slate-200 dark:border-slate-800"
      >
        <div class="flex items-center justify-between px-4 py-3">
          <!-- Left: back + title -->
          <div class="flex items-center gap-2">
            <!-- ✅ guaranteed working back (no JS needed) -->
            <button
              type="button"
              onclick="(history.length>1)?history.back():location.href='path.html'"
              class="press rounded-xl p-2 text-slate-400 hover:text-slate-600 dark:text-slate-500 dark:hover:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors"
              aria-label="Back"
            >
              <span class="material-symbols-outlined text-[28px]">arrow_back</span>
            </button>

            <h1 class="text-xl font-extrabold tracking-tight text-slate-800 dark:text-white">
              Practice Hub
            </h1>
          </div>

          <!-- Right: meta -->
          <div class="flex items-center gap-3">
            <div
              class="flex items-center gap-1.5 px-3 py-1.5 bg-white dark:bg-surface-dark rounded-full border-2 border-slate-100 dark:border-slate-700 shadow-sm"
              aria-label="Streak"
            >
              <span class="material-symbols-outlined text-orange-500 text-[20px]">local_fire_department</span>
              <span class="text-sm font-bold text-orange-500" id="streakVal">—</span>
            </div>

            <div
              class="hidden sm:flex items-center gap-1.5 px-3 py-1.5 bg-white dark:bg-surface-dark rounded-full border-2 border-slate-100 dark:border-slate-700 shadow-sm"
              aria-label="XP"
            >
              <span class="material-symbols-outlined text-yellow-500 text-[20px]">bolt</span>
              <span class="text-sm font-bold text-yellow-500" id="xpVal">—</span>
            </div>

            <div
              class="flex items-center gap-1.5 px-3 py-1.5 bg-white dark:bg-surface-dark rounded-full border-2 border-slate-100 dark:border-slate-700 shadow-sm"
              aria-label="Lives"
            >
              <span class="material-symbols-outlined text-red-500 text-[20px]">favorite</span>
              <span class="text-sm font-bold text-red-500" id="livesVal">—</span>
            </div>
          </div>
        </div>
      </header>

      <!-- Main scroll area -->
      <main class="flex-1 overflow-y-auto no-scrollbar px-4 pt-4 pb-10">
        <!-- Daily Goal Progress -->
        <div
          class="mb-6 bg-white dark:bg-surface-dark p-4 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-800"
        >
          <div class="flex justify-between items-end mb-2">
            <div class="flex flex-col">
              <span class="text-xs font-bold text-slate-400 uppercase tracking-wide">Daily Goal</span>
              <span class="text-lg font-bold text-slate-800 dark:text-white"
                ><span id="dailyXpText">0</span>/<span id="dailyXpGoal">100</span> XP</span
              >
            </div>
            <span class="text-primary text-sm font-bold" id="dailyCheer">Let’s go!</span>
          </div>

          <div class="w-full bg-slate-100 dark:bg-slate-700 rounded-full h-3 overflow-hidden">
            <div class="bg-primary h-3 rounded-full transition-all" id="dailyXpBar" style="width: 0%"></div>
          </div>

          <div class="mt-3 flex items-center justify-between text-xs font-semibold text-slate-500 dark:text-slate-400">
            <span>Tip: do one quick session to keep your streak alive.</span>
            <button
              id="setDailyGoalBtn"
              type="button"
              class="text-primary hover:text-primary-hover transition-colors"
              title="Set your daily XP goal"
            >
              Set goal
            </button>
          </div>

          <div id="dailyGoalSetter" class="mt-3 hidden items-center gap-2">
            <input
              id="dailyGoalInput"
              type="number"
              inputmode="numeric"
              min="10"
              max="1000"
              placeholder="XP goal"
              class="w-24 rounded-full border border-slate-200 dark:border-slate-700 bg-white dark:bg-surface-dark px-3 py-1 text-xs font-semibold text-slate-700 dark:text-slate-100 focus:outline-none focus:ring-2 focus:ring-primary/40"
            />
            <button
              id="saveDailyGoalBtn"
              type="button"
              class="rounded-full bg-primary text-white text-xs font-bold px-3 py-1.5 shadow-sm hover:bg-primary-hover transition-colors"
            >
              Save
            </button>
            <button
              id="cancelDailyGoalBtn"
              type="button"
              class="text-xs font-bold text-slate-400 hover:text-slate-600 transition-colors"
            >
              Cancel
            </button>
          </div>
        </div>

        <!-- Daily Warmup -->
        <button
          id="startWarmupBtn"
          type="button"
          class="press relative w-full aspect-[4/3] rounded-2xl overflow-hidden shadow-lg mb-6 group text-left"
        >
          <div class="absolute inset-0 bg-gradient-to-br from-indigo-500 to-purple-600"></div>
          <div class="absolute inset-0 bg-black/10"></div>

          <div class="absolute top-4 right-4 bg-white/20 backdrop-blur-sm rounded-full p-2">
            <span class="material-symbols-outlined text-white">wb_sunny</span>
          </div>

          <div
            class="absolute bottom-0 w-full p-5 bg-gradient-to-t from-black/80 via-black/40 to-transparent flex flex-col gap-2"
          >
            <div class="flex items-center gap-2 mb-1">
              <span class="px-2 py-0.5 bg-yellow-400 text-yellow-900 text-xs font-bold rounded-md uppercase"
                >Recommended</span
              >
              <span class="text-white/80 text-xs font-bold">+20 XP</span>
            </div>

            <h2 class="text-2xl font-bold text-white leading-tight">Daily Warmup</h2>
            <p class="text-white/90 text-sm font-medium line-clamp-2">
              Quick derivative mix: chain rule + implicit differentiation.
            </p>

            <div
              class="mt-2 w-full bg-white text-primary font-bold py-3 px-6 rounded-xl shadow-bubbly hover:bg-slate-50 transition-colors flex items-center justify-center gap-2"
            >
              <span class="material-symbols-outlined text-[20px]">play_arrow</span>
              Start Session
            </div>
          </div>
        </button>

        <!-- Specialized Practice -->
        <div class="flex items-center justify-between mb-4 mt-2">
          <h3 class="text-lg font-bold text-slate-800 dark:text-white">Specialized Practice</h3>
        </div>

        <!-- Mistakes Review -->
        <div
          class="bg-red-50 dark:bg-red-900/10 border-2 border-red-100 dark:border-red-900/30 rounded-2xl p-4 mb-4 flex items-center justify-between shadow-sm"
        >
          <div class="flex items-center gap-4">
            <div
              class="w-12 h-12 rounded-full bg-red-100 dark:bg-red-800 flex items-center justify-center text-red-500 dark:text-red-200 shadow-inner"
            >
              <span class="material-symbols-outlined text-[24px]">replay</span>
            </div>
            <div class="flex flex-col">
              <span class="font-bold text-slate-800 dark:text-white text-base">Mistakes Review</span>
              <span class="text-sm text-red-500/80 dark:text-red-300 font-medium"
                ><span id="mistakesCount">12</span> items pending</span
              >
            </div>
          </div>

          <button
            id="mistakesBtn"
            type="button"
            class="press bg-red-500 hover:bg-red-600 text-white font-bold text-sm px-4 py-2 rounded-xl shadow-[0_3px_0_0_#991b1b] transition-all"
          >
            Fix
          </button>
        </div>

        <!-- Timed Challenge -->
        <div
          class="bg-indigo-50 dark:bg-indigo-900/10 border-2 border-indigo-100 dark:border-indigo-900/30 rounded-2xl p-4 mb-4 flex items-center justify-between shadow-sm"
        >
          <div class="flex items-center gap-4">
            <div
              class="w-12 h-12 rounded-full bg-indigo-100 dark:bg-indigo-800 flex items-center justify-center text-indigo-500 dark:text-indigo-200 shadow-inner"
            >
              <span class="material-symbols-outlined text-[24px]">timer</span>
            </div>
            <div class="flex flex-col">
              <span class="font-bold text-slate-800 dark:text-white text-base">Timed Challenge</span>
              <span class="text-sm text-indigo-500/80 dark:text-indigo-300 font-medium">2× XP boost (demo)</span>
            </div>
          </div>

          <button
            id="timedBtn"
            type="button"
            class="press bg-indigo-500 hover:bg-indigo-600 text-white font-bold text-sm px-4 py-2 rounded-xl shadow-[0_3px_0_0_#3730a3] transition-all"
          >
            Go
          </button>
        </div>

        <!-- Topic Mastery -->
        <div class="mt-8 mb-4">
          <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-4">Topic Mastery</h3>

          <div class="grid grid-cols-1 gap-4">
            <!-- Limits -->
            <button
              id="topicLimitsBtn"
              type="button"
              class="press bg-white dark:bg-surface-dark p-4 rounded-2xl border-2 border-slate-100 dark:border-slate-800 shadow-sm relative overflow-hidden text-left"
            >
              <div
                class="absolute top-0 right-0 w-24 h-24 bg-sky-100 dark:bg-sky-900/20 rounded-bl-full -mr-4 -mt-4 opacity-50"
              ></div>

              <div class="relative z-10 flex flex-col gap-3">
                <div class="flex justify-between items-start">
                  <div class="flex items-center gap-3">
                    <div class="p-2 bg-sky-100 dark:bg-sky-900/40 rounded-lg text-sky-600 dark:text-sky-300">
                      <span class="material-symbols-outlined">function</span>
                    </div>
                    <div>
                      <h4 class="font-bold text-slate-800 dark:text-white">Limits &amp; Continuity</h4>
                      <p id="limitsLevelText" class="text-xs text-slate-500 dark:text-slate-400 font-medium">Level 0 - New</p>
                    </div>
                  </div>
                  <span id="limitsCheckIcon" class="material-symbols-outlined text-green-500 hidden">check_circle</span>
                </div>

                <div class="w-full bg-slate-100 dark:bg-slate-700 rounded-full h-2">
                  <div id="limitsProgressBar" class="bg-sky-500 h-2 rounded-full" style="width: 0%"></div>
                </div>
              </div>
            </button>

            <!-- Derivatives -->
            <button
              id="topicDerivativesBtn"
              type="button"
              class="press bg-white dark:bg-surface-dark p-4 rounded-2xl border-2 border-slate-100 dark:border-slate-800 shadow-sm relative overflow-hidden text-left"
            >
              <div
                class="absolute top-0 right-0 w-24 h-24 bg-emerald-100 dark:bg-emerald-900/20 rounded-bl-full -mr-4 -mt-4 opacity-50"
              ></div>

              <div class="relative z-10 flex flex-col gap-3">
                <div class="flex justify-between items-start">
                  <div class="flex items-center gap-3">
                    <div
                      class="p-2 bg-emerald-100 dark:bg-emerald-900/40 rounded-lg text-emerald-600 dark:text-emerald-300"
                    >
                      <span class="material-symbols-outlined">trending_up</span>
                    </div>
                    <div>
                      <h4 class="font-bold text-slate-800 dark:text-white">Derivatives</h4>
                      <p id="derivativesLevelText" class="text-xs text-slate-500 dark:text-slate-400 font-medium">Level 0 - New</p>
                    </div>
                  </div>
                </div>

                <div class="w-full bg-slate-100 dark:bg-slate-700 rounded-full h-2">
                  <div id="derivativesProgressBar" class="bg-emerald-500 h-2 rounded-full" style="width: 0%"></div>
                </div>
              </div>
            </button>

            <!-- Integrals locked -->
            <div
              class="bg-slate-50 dark:bg-slate-900/50 p-4 rounded-2xl border-2 border-slate-200 dark:border-slate-800 opacity-75"
            >
              <div class="flex flex-col gap-3">
                <div class="flex justify-between items-start">
                  <div class="flex items-center gap-3">
                    <div class="p-2 bg-slate-200 dark:bg-slate-800 rounded-lg text-slate-400">
                      <span class="material-symbols-outlined">area_chart</span>
                    </div>
                    <div>
                      <h4 class="font-bold text-slate-500 dark:text-slate-400">Integrals</h4>
                      <p class="text-xs text-slate-400 dark:text-slate-500 font-medium">Complete Derivatives Lvl 5</p>
                    </div>
                  </div>
                  <span class="material-symbols-outlined text-slate-400">lock</span>
                </div>
                <div class="w-full bg-slate-200 dark:bg-slate-800 rounded-full h-2"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="h-8"></div>
      </main>
    </div>

    <!-- Shared state -->
    <script src="state.js"></script>
    <script src="progress.js"></script>
    <script src="content-structure.js"></script>
    <script src="content-sections.js"></script>
    <script src="content-examples.js"></script>
    <script src="content-items.js"></script>
    <script src="content-tests.js"></script>
    <script src="content.js"></script>
    <script src="engine.js"></script>
    <script src="app.js"></script>

    <script>
      // Header meta
      (function () {
        const meta = window.FC?.get ? FC.get() : { streak: 0, xp: 0, lives: 0 };
        const streakEl = document.getElementById("streakVal");
        const xpEl = document.getElementById("xpVal");
        const livesEl = document.getElementById("livesVal");
        if (streakEl) streakEl.textContent = String(meta.streak ?? 0);
        if (xpEl) xpEl.textContent = String(meta.xp ?? 0);
        if (livesEl) livesEl.textContent = String(meta.lives ?? 0);
      })();

      function loadPrefs() {
        try {
          return JSON.parse(localStorage.getItem("fc_prefs") || "{}");
        } catch {
          return {};
        }
      }

      function savePrefs(next) {
        try {
          localStorage.setItem("fc_prefs", JSON.stringify(next));
        } catch {
          // ignore
        }
      }

      function getDailyGoal() {
        const prefs = loadPrefs();
        const raw = Number(prefs.dailyGoalXp ?? 100);
        if (!Number.isFinite(raw)) return 100;
        return Math.min(1000, Math.max(10, Math.round(raw)));
      }

      function getDailyXP() {
        const p = FCProgress.get();
        const today = new Date().toISOString().slice(0, 10);
        if (p.daily.date !== today) {
          p.daily.date = today;
          p.daily.xp = 0;
          FCProgress.set(p);
        }
        return p.daily.xp || 0;
      }

      function setDailyXP(v) {
        const DAILY_GOAL = getDailyGoal();
        const p = FCProgress.get();
        const today = new Date().toISOString().slice(0, 10);
        p.daily.date = today;
        p.daily.xp = Math.max(0, Math.min(DAILY_GOAL, v));
        FCProgress.set(p);
        renderDaily();
      }

      function renderDaily() {
        const DAILY_GOAL = getDailyGoal();
        const xp = getDailyXP();
        document.getElementById("dailyXpText").textContent = String(xp);
        document.getElementById("dailyXpGoal").textContent = String(DAILY_GOAL);
        document.getElementById("dailyXpBar").style.width = `${Math.round((xp / DAILY_GOAL) * 100)}%`;

        const cheer = document.getElementById("dailyCheer");
        if (!cheer) return;
        if (xp >= DAILY_GOAL) cheer.textContent = "Goal complete!";
        else if (xp >= 70) cheer.textContent = "Almost there!";
        else if (xp >= 35) cheer.textContent = "Keep it up!";
        else cheer.textContent = "Let's go!";
      }

      function masteryLabel(percent) {
        if (percent >= 85) return { level: 4, label: "Master" };
        if (percent >= 70) return { level: 3, label: "Skilled" };
        if (percent >= 50) return { level: 2, label: "Apprentice" };
        if (percent >= 25) return { level: 1, label: "Rising" };
        return { level: 0, label: "New" };
      }

      function averageMastery(tags) {
        if (!tags.length) return 0;
        const total = tags.reduce((sum, tag) => sum + FCProgress.getTagMastery(tag), 0);
        return Math.round(total / tags.length);
      }

      function updateTopicCard(tags, levelId, barId, checkId) {
        const mastery = averageMastery(tags);
        const level = masteryLabel(mastery);
        const levelEl = document.getElementById(levelId);
        const barEl = document.getElementById(barId);
        const checkEl = checkId ? document.getElementById(checkId) : null;
        if (levelEl) levelEl.textContent = `Level ${level.level} - ${level.label}`;
        if (barEl) barEl.style.width = `${mastery}%`;
        if (checkEl) checkEl.classList.toggle("hidden", mastery < 85);
      }

      function updateMistakes() {
        const count = FCProgress.get().mistakeItemIds.length;
        const el = document.getElementById("mistakesCount");
        if (el) el.textContent = String(count);
      }

      renderDaily();
      updateMistakes();
      updateTopicCard(
        ["limits.intro", "limits.one_sided", "limits.laws", "limits.algebraic"],
        "limitsLevelText",
        "limitsProgressBar",
        "limitsCheckIcon"
      );
      updateTopicCard(
        ["derivatives.power_rule", "derivatives.chain_rule"],
        "derivativesLevelText",
        "derivativesProgressBar",
        null
      );

      const setGoalBtn = document.getElementById("setDailyGoalBtn");
      const goalSetter = document.getElementById("dailyGoalSetter");
      const goalInput = document.getElementById("dailyGoalInput");
      const saveGoalBtn = document.getElementById("saveDailyGoalBtn");
      const cancelGoalBtn = document.getElementById("cancelDailyGoalBtn");

      setGoalBtn?.addEventListener("click", () => {
        if (!goalSetter || !goalInput) return;
        goalSetter.classList.remove("hidden");
        goalInput.value = String(getDailyGoal());
        goalInput.focus();
      });

      cancelGoalBtn?.addEventListener("click", () => {
        goalSetter?.classList.add("hidden");
      });

      saveGoalBtn?.addEventListener("click", () => {
        if (!goalInput) return;
        const next = Number(goalInput.value);
        if (!Number.isFinite(next)) return;
        const prefs = loadPrefs();
        prefs.dailyGoalXp = Math.min(1000, Math.max(10, Math.round(next)));
        savePrefs(prefs);
        goalSetter?.classList.add("hidden");
        renderDaily();
      });

      function startSession(options) {
        const session = FCEngine.createSession(options);
        if (!session) return;
        FCEngine.saveSession(session);
        window.location.href = "active-lesson.html";
      }

      document.getElementById("startWarmupBtn")?.addEventListener("click", () => {
        startSession({
          mode: "practice",
          tags: ["limits.intro", "limits.one_sided", "limits.laws"],
          count: 5,
          types: ["mcq", "numeric", "expression"],
          xpPerCorrect: 8,
        });
      });

      document.getElementById("mistakesBtn")?.addEventListener("click", () => {
        const mistakes = FCProgress.get().mistakeItemIds || [];
        if (!mistakes.length) {
          if (window.FCUI?.showComingSoon) {
            window.FCUI.showComingSoon({
              title: "All caught up!",
              message: "No mistakes pending right now. Great work!",
              primaryLabel: "Nice!",
              primaryIcon: "check_circle",
              enableNotifications: false,
            });
            return;
          }
          alert("No mistakes queued. Nice work!");
          return;
        }
        startSession({
          mode: "practice",
          itemIds: mistakes.slice(0, 5),
          count: Math.min(5, mistakes.length),
          types: ["mcq", "numeric", "expression"],
          xpPerCorrect: 8,
        });
      });

      document.getElementById("timedBtn")?.addEventListener("click", () => {
        if (window.FCUI?.showComingSoon) {
          window.FCUI.showComingSoon({
            title: "Timed Challenge",
            message: "Timed challenge mode is under construction. It’ll be ready soon.",
          });
          return;
        }
        alert("Timed Challenge (coming soon).");
      });
      document.getElementById("topicLimitsBtn")?.addEventListener("click", () => {
        startSession({
          mode: "practice",
          tags: ["limits.intro", "limits.one_sided", "limits.laws"],
          count: 5,
          types: ["mcq", "numeric", "expression"],
          xpPerCorrect: 8,
        });
      });
      document.getElementById("topicDerivativesBtn")?.addEventListener("click", () => {
        startSession({
          mode: "practice",
          tags: ["derivatives.power_rule", "derivatives.chain_rule"],
          count: 5,
          types: ["mcq", "numeric", "expression"],
          xpPerCorrect: 8,
        });
      });
    </script>
  </body>
</html>










