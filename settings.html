<!DOCTYPE html>
<html class="light" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <link rel="manifest" href="manifest.webmanifest" />
    <meta name="theme-color" content="#1cb0f6" />
    <link rel="apple-touch-icon" href="icons/icon-192.png" />
    <link rel="icon" type="image/png" href="icons/icon-192.png" />
    <title>Full Calculus — Settings</title>

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

    <link
      href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@100..700&display=swap"
      rel="stylesheet"
    />

    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#1cb0f6",
              "primary-hover": "#1599d4",
              "background-light": "#f5f6f8",
              "background-dark": "#101622",
              "surface-light": "#ffffff",
              "surface-dark": "#1a2332",
              "text-main": "#0d121c",
            },
            fontFamily: {
              display: ["Lexend", "sans-serif"],
            },
            borderRadius: {
              DEFAULT: "1rem",
              lg: "1.5rem",
              xl: "2rem",
              full: "9999px",
            },
            boxShadow: {
              soft: "0 4px 20px -2px rgba(0,0,0,0.06)",
              "press-blue": "0 4px 0 0 #1599d4",
            },
          },
        },
      };
    </script>

    <style>
      body {
        font-family: "Lexend", sans-serif;
        min-height: max(884px, 100dvh);
      }
      .material-symbols-outlined {
        font-variation-settings: "FILL" 1, "wght" 550, "GRAD" 0, "opsz" 24;
      }
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      .press:active {
        transform: translateY(4px);
        box-shadow: none !important;
      }

      /* iOS-like switch */
      .ios-switch {
        position: relative;
        display: inline-block;
        width: 46px;
        height: 26px;
      }
      .ios-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .slider {
        position: absolute;
        cursor: pointer;
        inset: 0;
        background-color: #cbd5e1;
        transition: 0.25s;
        border-radius: 999px;
      }
      .slider:before {
        position: absolute;
        content: "";
        height: 22px;
        width: 22px;
        left: 2px;
        bottom: 2px;
        background-color: white;
        transition: 0.25s;
        border-radius: 999px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
      }
      input:checked + .slider {
        background-color: #1cb0f6;
      }
      input:checked + .slider:before {
        transform: translateX(20px);
      }
    </style>
    <script src="theme.js"></script>
  </head>

  <body
    data-step="settings"
    class="bg-background-light dark:bg-background-dark text-text-main dark:text-white transition-colors duration-200 antialiased"
  >
    <!-- Mobile shell (Full Calculus structure) -->
    <div
      class="w-full max-w-md mx-auto h-[100dvh] sm:min-h-screen bg-background-light dark:bg-background-dark shadow-2xl flex flex-col overflow-hidden"
    >
      <!-- Sticky Header -->
      <header
        class="sticky top-0 z-30 bg-background-light/90 dark:bg-background-dark/90 backdrop-blur-md border-b border-slate-200 dark:border-slate-800"
      >
        <div class="flex items-center p-4 justify-between">
          <div class="flex items-center gap-2">
            <button
  type="button"
  onclick="(history.length > 1) ? history.back() : location.href='path.html'"
  class="press flex items-center justify-center w-10 h-10 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors"
  aria-label="Back"
>
  <span class="material-symbols-outlined text-primary">arrow_back</span>
</button>

            <h2 class="text-lg font-extrabold leading-tight tracking-tight">Settings</h2>
          </div>

          <button
            id="saveBtn"
            type="button"
            class="press text-primary text-sm font-extrabold px-4 py-2 rounded-xl bg-primary/10 hover:bg-primary/15 transition-colors"
          >
            Save
          </button>
        </div>
      </header>

      <!-- Scrollable content -->
      <main class="flex-1 overflow-y-auto no-scrollbar px-4 pb-10">
        <!-- Profile Header -->
        <div class="flex items-center gap-4 py-6">
          <div class="relative">
            <div
              class="size-16 rounded-full bg-primary/10 flex items-center justify-center border-2 border-primary overflow-hidden bg-cover bg-center"
              id="avatar"
              style="background-image:url('https://github.com/juliuskalume/full-calculus/blob/main/icons/icon-192.png?raw=true');"
              aria-label="User avatar"
            ></div>
            <div
              class="absolute -bottom-1 -right-1 bg-yellow-400 size-6 rounded-full flex items-center justify-center border-2 border-white dark:border-background-dark"
              aria-hidden="true"
            >
              <span class="material-symbols-outlined text-[14px] text-white">bolt</span>
            </div>
          </div>

          <div class="min-w-0">
            <h3 id="nameText" class="text-xl font-extrabold truncate">Student</h3>
            <p class="text-primary text-sm font-semibold">
              <span id="courseText">Calculus I</span> • <span id="leagueText">Diamond League</span>
            </p>
            <button
              id="changeAvatarBtn"
              type="button"
              class="mt-2 inline-flex items-center gap-1 text-xs font-bold text-primary hover:text-primary-hover transition-colors"
            >
              <span class="material-symbols-outlined text-[16px]">photo_camera</span>
              Change avatar
            </button>
          </div>
        </div>
        <div id="avatarPickerWrap" class="hidden mb-6">
          <p class="text-xs font-semibold text-slate-500 dark:text-slate-400 mb-2 px-1">Choose an avatar</p>
          <div id="avatarPicker" class="grid grid-cols-4 gap-3">
            <button
              type="button"
              class="avatar-option press p-0 rounded-xl transition-transform duration-200 hover:scale-[1.04] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/50"
              data-avatar="icons/avatar-fox-green.png"
              aria-label="Green fox"
            >
              <div
                class="w-12 h-12 rounded-xl bg-cover bg-center"
                style="background-image:url('icons/avatar-fox-green.png');"
              ></div>
            </button>
            <button
              type="button"
              class="avatar-option press p-0 rounded-xl transition-transform duration-200 hover:scale-[1.04] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/50"
              data-avatar="icons/avatar-fox-red.png"
              aria-label="Red fox"
            >
              <div
                class="w-12 h-12 rounded-xl bg-cover bg-center"
                style="background-image:url('icons/avatar-fox-red.png');"
              ></div>
            </button>
            <button
              type="button"
              class="avatar-option press p-0 rounded-xl transition-transform duration-200 hover:scale-[1.04] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/50"
              data-avatar="icons/avatar-fox-yellow.png"
              aria-label="Yellow fox"
            >
              <div
                class="w-12 h-12 rounded-xl bg-cover bg-center"
                style="background-image:url('icons/avatar-fox-yellow.png');"
              ></div>
            </button>
            <button
              type="button"
              class="avatar-option press p-0 rounded-xl transition-transform duration-200 hover:scale-[1.04] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/50"
              data-avatar="icons/avatar-fox-blue.png"
              aria-label="Blue fox"
            >
              <div
                class="w-12 h-12 rounded-xl bg-cover bg-center"
                style="background-image:url('icons/avatar-fox-blue.png');"
              ></div>
            </button>
          </div>
        </div>

        <!-- Account -->
        <section class="mb-6">
          <h3 class="text-sm font-extrabold uppercase tracking-wider text-slate-500 dark:text-slate-400 px-1 pb-2">
            Account
          </h3>

          <div class="bg-white dark:bg-surface-dark rounded-2xl overflow-hidden shadow-sm border border-slate-100 dark:border-slate-800">
            <div class="flex items-center gap-4 px-4 min-h-[72px] py-2 justify-between border-b border-slate-100/60 dark:border-slate-800">
              <div class="flex flex-col justify-center min-w-0 flex-1">
                <p class="text-base font-semibold leading-normal">Name</p>
                <input
                  id="nameInput"
                  type="text"
                  class="mt-1 w-full rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-surface-dark px-3 py-2 text-sm font-semibold text-slate-800 dark:text-slate-100 focus:outline-none focus:ring-2 focus:ring-primary/40"
                  placeholder="Your name"
                  autocomplete="name"
                />
              </div>
            </div>

            <div class="flex items-center gap-4 px-4 min-h-[72px] py-2 justify-between border-b border-slate-100/60 dark:border-slate-800">
              <div class="flex flex-col justify-center min-w-0">
                <p class="text-base font-semibold leading-normal">Email</p>
                <p id="emailText" class="text-slate-500 dark:text-slate-400 text-sm font-medium leading-normal truncate">
                  not set
                </p>
              </div>
            </div>

            <div class="flex items-center gap-4 px-4 min-h-[56px] justify-between">
              <p class="text-base font-semibold leading-normal flex-1">Password</p>
              <button
                id="changePwBtn"
                class="press flex min-w-[90px] items-center justify-center rounded-xl h-9 px-4 bg-primary/10 text-primary text-sm font-extrabold hover:bg-primary/20 transition-colors"
                type="button"
              >
                Change
              </button>
            </div>

            <div id="passwordPanel" class="hidden px-4 pb-4">
              <div class="mt-3 grid gap-3">
                <div class="relative">
                  <input
                    id="currentPw"
                    type="password"
                    class="w-full rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-surface-dark px-3 py-2 pr-10 text-sm font-semibold text-slate-800 dark:text-slate-100 focus:outline-none focus:ring-2 focus:ring-primary/40"
                    placeholder="Current password"
                    autocomplete="current-password"
                  />
                  <button
                    id="toggleCurrentPw"
                    type="button"
                    class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-primary transition-colors"
                    aria-label="Toggle password visibility"
                  >
                    <span class="material-symbols-outlined text-[20px]">visibility_off</span>
                  </button>
                </div>
                <div class="relative">
                  <input
                    id="newPw"
                    type="password"
                    class="w-full rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-surface-dark px-3 py-2 pr-10 text-sm font-semibold text-slate-800 dark:text-slate-100 focus:outline-none focus:ring-2 focus:ring-primary/40"
                    placeholder="New password"
                    autocomplete="new-password"
                  />
                  <button
                    id="toggleNewPw"
                    type="button"
                    class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-primary transition-colors"
                    aria-label="Toggle password visibility"
                  >
                    <span class="material-symbols-outlined text-[20px]">visibility_off</span>
                  </button>
                </div>
                <div class="relative">
                  <input
                    id="confirmPw"
                    type="password"
                    class="w-full rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-surface-dark px-3 py-2 pr-10 text-sm font-semibold text-slate-800 dark:text-slate-100 focus:outline-none focus:ring-2 focus:ring-primary/40"
                    placeholder="Confirm new password"
                    autocomplete="new-password"
                  />
                  <button
                    id="toggleConfirmPw"
                    type="button"
                    class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-primary transition-colors"
                    aria-label="Toggle password visibility"
                  >
                    <span class="material-symbols-outlined text-[20px]">visibility_off</span>
                  </button>
                </div>
                <button
                  id="updatePwBtn"
                  type="button"
                  class="press w-full h-11 rounded-xl bg-primary text-white font-extrabold uppercase tracking-wide shadow-[0_4px_0_0_#1599d4] hover:bg-primary-hover"
                >
                  Update Password
                </button>
              </div>
            </div>
          </div>
          <p id="accountStatus" class="mt-3 text-xs font-semibold text-emerald-600 hidden"></p>
          <p id="accountError" class="mt-1 text-xs font-semibold text-red-500 hidden"></p>
        </section>

        <!-- Daily Goal -->
        <section class="mb-6">
          <h3 class="text-sm font-extrabold uppercase tracking-wider text-slate-500 dark:text-slate-400 px-1 pb-2">
            Daily Goal
          </h3>

          <div class="bg-white dark:bg-surface-dark rounded-2xl p-4 shadow-sm border border-slate-100 dark:border-slate-800">
            <div class="flex items-center justify-between mb-4">
              <div>
                <p class="text-base font-extrabold" id="goalName">Regular</p>
                <p class="text-sm text-slate-500 dark:text-slate-400 font-medium" id="goalDesc">15 minutes / day</p>
              </div>
              <span class="material-symbols-outlined text-primary">schedule</span>
            </div>

            <div class="grid grid-cols-4 gap-2" id="goalGrid">
              <button data-goal="casual" class="press flex flex-col items-center justify-center p-2 rounded-xl border border-slate-200 dark:border-slate-800 text-xs font-extrabold hover:bg-primary/5" type="button">
                Casual
              </button>
              <button data-goal="regular" class="press flex flex-col items-center justify-center p-2 rounded-xl border-2 border-primary bg-primary/5 text-xs font-extrabold text-primary" type="button">
                Regular
              </button>
              <button data-goal="serious" class="press flex flex-col items-center justify-center p-2 rounded-xl border border-slate-200 dark:border-slate-800 text-xs font-extrabold hover:bg-primary/5" type="button">
                Serious
              </button>
              <button data-goal="intense" class="press flex flex-col items-center justify-center p-2 rounded-xl border border-slate-200 dark:border-slate-800 text-xs font-extrabold hover:bg-primary/5" type="button">
                Intense
              </button>
            </div>
          </div>
        </section>

        <!-- Preferences -->
        <section class="mb-6">
          <h3 class="text-sm font-extrabold uppercase tracking-wider text-slate-500 dark:text-slate-400 px-1 pb-2">
            Preferences (might need Restart)
          </h3>

          <div class="bg-white dark:bg-surface-dark rounded-2xl overflow-hidden shadow-sm border border-slate-100 dark:border-slate-800">
            <div class="flex items-center gap-4 px-4 min-h-[56px] justify-between border-b border-slate-100/60 dark:border-slate-800">
              <div class="flex items-center gap-3">
                <span class="material-symbols-outlined text-slate-500">dark_mode</span>
                <p class="text-base font-semibold">Dark Mode</p>
              </div>
              <label class="ios-switch" aria-label="Dark Mode toggle">
                <input id="darkModeSwitch" type="checkbox" />
                <span class="slider"></span>
              </label>
            </div>

            <div class="flex items-center gap-4 px-4 min-h-[56px] justify-between border-b border-slate-100/60 dark:border-slate-800">
              <div class="flex items-center gap-3">
                <span class="material-symbols-outlined text-slate-500">volume_up</span>
                <p class="text-base font-semibold">Sound Effects</p>
              </div>
              <label class="ios-switch" aria-label="Sound Effects toggle">
                <input id="soundSwitch" type="checkbox" checked />
                <span class="slider"></span>
              </label>
            </div>

            <div class="flex items-center gap-4 px-4 min-h-[56px] justify-between">
              <div class="flex items-center gap-3">
                <span class="material-symbols-outlined text-slate-500">auto_awesome</span>
                <p class="text-base font-semibold">Motivations</p>
              </div>
              <label class="ios-switch" aria-label="Motivations toggle">
                <input id="motivationSwitch" type="checkbox" checked />
                <span class="slider"></span>
              </label>
            </div>

            <div class="flex items-center gap-4 px-4 min-h-[56px] justify-between border-t border-slate-100/60 dark:border-slate-800">
              <div class="flex items-center gap-3">
                <span class="material-symbols-outlined text-slate-500">vibration</span>
                <p class="text-base font-semibold">Vibration</p>
              </div>
              <label class="ios-switch" aria-label="Vibration toggle">
                <input id="hapticSwitch" type="checkbox" checked />
                <span class="slider"></span>
              </label>
            </div>

            <div class="flex items-center gap-4 px-4 min-h-[56px] justify-between border-t border-slate-100/60 dark:border-slate-800">
              <div class="flex items-center gap-3">
                <span class="material-symbols-outlined text-slate-500">notifications</span>
                <p class="text-base font-semibold">Learning Reminders</p>
              </div>
              <label class="ios-switch" aria-label="Learning Reminders toggle">
                <input id="notifySwitch" type="checkbox" />
                <span class="slider"></span>
              </label>
            </div>
            <div class="px-4 pb-3 text-xs text-slate-500 dark:text-slate-400 hidden" id="notifyStatus"></div>
          </div>
        </section>

        <!-- Other / Danger -->
        <section class="mb-10 space-y-3">
          <button
            id="privacyBtn"
            class="press w-full flex items-center justify-between px-4 py-3 bg-white dark:bg-surface-dark rounded-2xl border border-slate-100 dark:border-slate-800 text-slate-700 dark:text-slate-200 font-semibold"
            type="button"
          >
            Privacy Policy
            <span class="material-symbols-outlined text-slate-400">chevron_right</span>
          </button>

          <button
            id="logoutBtn"
            class="press w-full flex items-center justify-center px-4 py-3 text-red-500 font-extrabold border border-red-100 dark:border-red-900/30 rounded-2xl bg-red-50 dark:bg-red-900/10 hover:bg-red-100 dark:hover:bg-red-900/20 transition-colors"
            type="button"
          >
            Log Out
          </button>
        </section>
      </main>
    </div>

    <!-- Shared state -->
    <script src="state.js"></script>
    <script src="progress.js"></script>
    <script src="firebase-config.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="auth.js"></script>
    <script src="./app.js"></script>

    <script>
      // ---- helpers ----
      function loadFcState() {
        try {
          return JSON.parse(localStorage.getItem("fc_state") || "{}");
        } catch {
          return {};
        }
      }
      function saveFcState(state) {
        try {
          localStorage.setItem("fc_state", JSON.stringify(state));
        } catch {
          // ignore
        }
      }
      function savePrefs(p) {
        localStorage.setItem("fc_prefs", JSON.stringify(p));
      }
      function loadPrefs() {
        try {
          return JSON.parse(localStorage.getItem("fc_prefs") || "{}");
        } catch {
          return {};
        }
      }
      function clearLocalData() {
        try {
          const keys = [];
          for (let i = 0; i < localStorage.length; i += 1) {
            const key = localStorage.key(i);
            if (key && key.startsWith("fc_")) keys.push(key);
          }
          keys.forEach((key) => localStorage.removeItem(key));
        } catch {
          try {
            localStorage.clear();
          } catch {
            // ignore
          }
        }

        try {
          sessionStorage.clear();
        } catch {
          // ignore
        }
      }

      function setMessage(el, msg) {
        if (!el) return;
        if (!msg) {
          el.classList.add("hidden");
          el.textContent = "";
          return;
        }
        el.textContent = msg;
        el.classList.remove("hidden");
      }

      function logDevError(context, err) {
        const entry = {
          time: new Date().toISOString(),
          context,
          code: err?.code || "",
          message: err?.message || String(err || ""),
          stack: err?.stack || "",
        };
        try {
          const raw = localStorage.getItem("fc_dev_errors");
          const list = raw ? JSON.parse(raw) : [];
          list.push(entry);
          localStorage.setItem("fc_dev_errors", JSON.stringify(list.slice(-50)));
        } catch {
          // ignore
        }
        try {
          console.error("[Dev]", entry);
        } catch {
          // ignore
        }
      }

      function friendlyAuthMessage(err, fallback) {
        const code = err?.code || "";
        if (code === "auth/invalid-email") return "Enter a valid email address.";
        if (code === "auth/user-not-found" || code === "auth/wrong-password") {
          return "Incorrect email or password.";
        }
        if (code === "auth/too-many-requests") {
          return "Too many attempts. Please try again later.";
        }
        if (code === "auth/network-request-failed") {
          return "Network error. Check your connection and try again.";
        }
        if (code === "auth/requires-recent-login") {
          return "Please sign in again, then retry this action.";
        }
        if (code === "auth/weak-password") {
          return "Use a stronger password (at least 6 characters).";
        }
        return fallback;
      }

      const DEFAULT_AVATAR =
        "https://github.com/juliuskalume/full-calculus/blob/main/icons/icon-192.png?raw=true";

      // Hydrate header info from onboarding state
      (function hydrateProfileHeader() {
        const s = loadFcState();
        const meta = window.FC?.get ? FC.get() : { xp: 0, streak: 0, lives: 0 };
        const authUser = window.FCAuth?.getCurrentUser ? FCAuth.getCurrentUser() : null;

        const name = (s.name && String(s.name).trim()) || authUser?.displayName || "Student";
        const avatarUrl = s.avatarUrl || authUser?.photoURL || DEFAULT_AVATAR;

        document.getElementById("nameText").textContent = name;
        document.getElementById("avatar").style.backgroundImage = `url('${avatarUrl}')`;
        window.__fc_avatar_current = avatarUrl;
        const nameInput = document.getElementById("nameInput");
        if (nameInput) nameInput.value = name;

        // optional: make league/course feel dynamic later; placeholders for now
        document.getElementById("courseText").textContent = s.course || "Calculus I";
        document.getElementById("leagueText").textContent = s.league || "Diamond League";

        const emailValue = authUser?.email || s.email || "not set";
        document.getElementById("emailText").textContent = String(emailValue);
      })();

      // Dark mode preference (keeps it consistent across screens)
      (function initPrefs() {
        const prefs = loadPrefs();

        const darkSwitch = document.getElementById("darkModeSwitch");
        const soundSwitch = document.getElementById("soundSwitch");
        const motivationSwitch = document.getElementById("motivationSwitch");
        const hapticSwitch = document.getElementById("hapticSwitch");
        const notifySwitch = document.getElementById("notifySwitch");
        const notifyStatus = document.getElementById("notifyStatus");

        // hydrate switches
        const isDark = document.documentElement.classList.contains("dark");
        darkSwitch.checked = prefs.darkMode ?? isDark;
        soundSwitch.checked = prefs.sound ?? true;
        motivationSwitch.checked = prefs.motivation ?? true;
        hapticSwitch.checked = prefs.vibration ?? true;
        const notifyState = loadFcState();
        notifySwitch.checked = !!notifyState.notifications;

        // apply dark mode immediately
        if (darkSwitch.checked) {
          document.documentElement.classList.add("dark");
          document.documentElement.classList.remove("light");
        } else {
          document.documentElement.classList.remove("dark");
          document.documentElement.classList.add("light");
        }

        function persist() {
          const current = loadPrefs();
          savePrefs({
            ...current,
            darkMode: darkSwitch.checked,
            sound: soundSwitch.checked,
            motivation: motivationSwitch.checked,
            vibration: hapticSwitch.checked,
            dailyGoal: current.dailyGoal || "regular",
          });
        }


        darkSwitch.addEventListener("change", () => {
          if (darkSwitch.checked) {
            document.documentElement.classList.add("dark");
            document.documentElement.classList.remove("light");
          } else {
            document.documentElement.classList.remove("dark");
            document.documentElement.classList.add("light");
          }
          persist();
        });
        soundSwitch.addEventListener("change", persist);
        motivationSwitch.addEventListener("change", persist);
        hapticSwitch.addEventListener("change", persist);
        notifySwitch.addEventListener("change", async () => {
          const s = loadFcState();
          s.notifications = notifySwitch.checked;
          saveFcState(s);
          if (notifySwitch.checked) {
            if (window.FCPush?.requestPermissionAndSubscribe) {
              try {
                await window.FCPush.requestPermissionAndSubscribe();
              } catch {
                // ignore
              }
            }
          } else {
            if (window.FCPush?.disable) {
              try {
                await window.FCPush.disable();
              } catch {
                // ignore
              }
            }
          }
        });
      })();

      // Daily goal selector UI
      (function initDailyGoal() {
        const goalMap = {
          casual: { name: "Casual", desc: "10 minutes / day" },
          regular: { name: "Regular", desc: "15 minutes / day" },
          serious: { name: "Serious", desc: "20 minutes / day" },
          intense: { name: "Intense", desc: "30 minutes / day" },
        };

        const prefs = loadPrefs();
        let goal = prefs.dailyGoal || "regular";

        const goalName = document.getElementById("goalName");
        const goalDesc = document.getElementById("goalDesc");
        const grid = document.getElementById("goalGrid");

        function render() {
          goalName.textContent = goalMap[goal].name;
          goalDesc.textContent = goalMap[goal].desc;

          [...grid.querySelectorAll("button[data-goal]")].forEach((btn) => {
            const active = btn.dataset.goal === goal;
            btn.classList.toggle("border-2", active);
            btn.classList.toggle("border-primary", active);
            btn.classList.toggle("bg-primary/5", active);
            btn.classList.toggle("text-primary", active);

            btn.classList.toggle("border", !active);
            btn.classList.toggle("border-slate-200", !active);
            btn.classList.toggle("dark:border-slate-800", !active);
          });

          const p = loadPrefs();
          savePrefs({ ...p, dailyGoal: goal });
        }

        grid.addEventListener("click", (e) => {
          const btn = e.target.closest("button[data-goal]");
          if (!btn) return;
          goal = btn.dataset.goal;
          render();
        });

        render();
      })();

      const accountStatus = document.getElementById("accountStatus");
      const accountError = document.getElementById("accountError");
      const nameInput = document.getElementById("nameInput");
      const avatarEl = document.getElementById("avatar");
      const changeAvatarBtn = document.getElementById("changeAvatarBtn");
      const avatarPickerWrap = document.getElementById("avatarPickerWrap");
      const avatarOptions = Array.from(document.querySelectorAll(".avatar-option"));

      let pendingAvatarUrl = null;

      const applyAvatar = (url) => {
        if (avatarEl && url) avatarEl.style.backgroundImage = `url('${url}')`;
      };

      const updateAvatarSelection = (url) => {
        avatarOptions.forEach((btn) => {
          const isActive = btn.dataset.avatar === url;
          btn.classList.toggle("ring-2", isActive);
          btn.classList.toggle("ring-primary/70", isActive);
        });
      };

      changeAvatarBtn?.addEventListener("click", () => {
        avatarPickerWrap?.classList.toggle("hidden");
        const current = pendingAvatarUrl || window.__fc_avatar_current || DEFAULT_AVATAR;
        updateAvatarSelection(current);
      });

      avatarOptions.forEach((btn) => {
        btn.addEventListener("click", () => {
          setMessage(accountError, "");
          const url = btn.dataset.avatar;
          if (!url) return;
          pendingAvatarUrl = url;
          applyAvatar(url);
          updateAvatarSelection(url);
        });
      });

      updateAvatarSelection(window.__fc_avatar_current);

      // Save profile updates
      document.getElementById("saveBtn")?.addEventListener("click", async () => {
        setMessage(accountError, "");
        setMessage(accountStatus, "Saving...");

        const s = loadFcState();
        const nextName = (nameInput?.value || "").trim();
        if (nextName) s.name = nextName;
        if (pendingAvatarUrl) s.avatarUrl = pendingAvatarUrl;
        saveFcState(s);

        document.getElementById("nameText").textContent = s.name || "Student";
        applyAvatar(s.avatarUrl);

        if (window.FCAuth?.enabled && FCAuth.getCurrentUser && FCAuth.getCurrentUser()) {
          try {
            const user = FCAuth.getCurrentUser();
            if (user?.updateProfile) {
              await user.updateProfile({
                displayName: s.name || user.displayName || "",
                photoURL: s.avatarUrl || user.photoURL || "",
              });
            }
            await FCAuth.syncToRemote({ name: s.name, avatarUrl: s.avatarUrl, email: s.email });
            setMessage(accountStatus, "Saved.");
          } catch (err) {
            setMessage(accountError, friendlyAuthMessage(err, "Unable to save right now."));
            logDevError("settings-save", err);
          }
        } else {
          setMessage(accountStatus, "Saved locally. Sign in to sync.");
        }
      });

      // Password change
      const changePwBtn = document.getElementById("changePwBtn");
      const passwordPanel = document.getElementById("passwordPanel");
      const updatePwBtn = document.getElementById("updatePwBtn");
      const currentPw = document.getElementById("currentPw");
      const newPw = document.getElementById("newPw");
      const confirmPw = document.getElementById("confirmPw");

      function bindPasswordToggle(buttonId, inputEl) {
        const btn = document.getElementById(buttonId);
        if (!btn || !inputEl) return;
        btn.addEventListener("click", () => {
          const isPw = inputEl.type === "password";
          inputEl.type = isPw ? "text" : "password";
          const icon = btn.querySelector(".material-symbols-outlined");
          if (icon) icon.textContent = isPw ? "visibility" : "visibility_off";
        });
      }

      function resetPasswordVisibility() {
        const pairs = [
          { input: currentPw, btnId: "toggleCurrentPw" },
          { input: newPw, btnId: "toggleNewPw" },
          { input: confirmPw, btnId: "toggleConfirmPw" },
        ];
        pairs.forEach(({ input, btnId }) => {
          if (!input) return;
          input.type = "password";
          const icon = document.querySelector(`#${btnId} .material-symbols-outlined`);
          if (icon) icon.textContent = "visibility_off";
        });
      }

      bindPasswordToggle("toggleCurrentPw", currentPw);
      bindPasswordToggle("toggleNewPw", newPw);
      bindPasswordToggle("toggleConfirmPw", confirmPw);

      changePwBtn?.addEventListener("click", () => {
        passwordPanel?.classList.toggle("hidden");
      });

      updatePwBtn?.addEventListener("click", async () => {
        setMessage(accountError, "");
        setMessage(accountStatus, "");

        if (!window.FCAuth?.enabled || !FCAuth.getCurrentUser) {
          setMessage(accountError, "Password updates are unavailable right now.");
          return;
        }

        const user = FCAuth.getCurrentUser();
        if (!user) {
          setMessage(accountError, "Please sign in to change your password.");
          return;
        }

        const providers = Array.isArray(user.providerData) ? user.providerData : [];
        const hasPassword = providers.some((p) => p.providerId === "password");
        if (!hasPassword) {
          setMessage(accountError, "This account uses Google sign-in. Add a password in your browser first.");
          return;
        }

        const current = currentPw?.value || "";
        const next = newPw?.value || "";
        const confirm = confirmPw?.value || "";
        if (!current || !next) {
          setMessage(accountError, "Enter your current and new password.");
          return;
        }
        if (next.length < 6) {
          setMessage(accountError, "Use a stronger password (at least 6 characters).");
          return;
        }
        if (next !== confirm) {
          setMessage(accountError, "Passwords do not match.");
          return;
        }

        setMessage(accountStatus, "Updating password...");
        try {
          const credential = firebase.auth.EmailAuthProvider.credential(user.email || "", current);
          await user.reauthenticateWithCredential(credential);
          await user.updatePassword(next);
          if (currentPw) currentPw.value = "";
          if (newPw) newPw.value = "";
          if (confirmPw) confirmPw.value = "";
          resetPasswordVisibility();
          passwordPanel?.classList.add("hidden");
          setMessage(accountStatus, "Password updated.");
        } catch (err) {
          setMessage(accountError, friendlyAuthMessage(err, "Unable to update password."));
          logDevError("settings-password", err);
        }
      });

      // Privacy + Logout
      document.getElementById("privacyBtn")?.addEventListener("click", () => {
        window.location.href = "privacy.html";
      });

      document.getElementById("logoutBtn")?.addEventListener("click", async () => {
        if (window.FCAuth?.enabled) {
          try {
            await FCAuth.signOut();
          } catch {
            // ignore
          }
        }
        clearLocalData();
        window.location.href = "login.html";
      });
    </script>
  </body>
</html>




