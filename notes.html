<!DOCTYPE html>
<html class="light" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <link rel="manifest" href="manifest.webmanifest" />
    <meta name="theme-color" content="#1cb0f6" />
    <link rel="apple-touch-icon" href="icons/icon-192.png" />
    <link rel="icon" type="image/png" href="icons/icon-192.png" />
    <title>Full Calculus — Notes</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

    <link
      href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Serif:ital,wght@0,400;0,700;1,400&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
      rel="stylesheet"
    />

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    
    <!-- MathJax -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [["\\(", "\\)"]],
          displayMath: [["\\[", "\\]"]],
        },
        chtml: {
          linebreaks: { automatic: true, width: "container" },
        },
      };
    </script>
    <script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#1cb0f6",
              "primary-dark": "#1599d4",
              "background-light": "#f5f6f8",
              "background-dark": "#101622",
              "surface-light": "#ffffff",
              "surface-dark": "#1e293b",
              "text-main": "#0d121c",
              "text-sub": "#49659c",
            },
            fontFamily: {
              display: ["Lexend", "sans-serif"],
              math: ["Noto Serif", "serif"],
            },
            borderRadius: {
              DEFAULT: "1rem",
              lg: "1.5rem",
              xl: "2rem",
              full: "9999px",
            },
          },
        },
      };
    </script>

    <style>
      body {
        font-family: "Lexend", sans-serif;
        min-height: max(884px, 100dvh);
      }
      .material-symbols-outlined {
        font-variation-settings: "FILL" 1, "wght" 650, "GRAD" 0, "opsz" 24;
      }
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      .math-text {
        font-family: "Noto Serif", serif;
      }
      .math-var {
        font-style: italic;
      }
      #notesContent,
      #notesContent p,
      #notesContent li,
      #notesContent .math-text {
        overflow-wrap: anywhere;
        word-break: break-word;
      }
      #notesContent mjx-container {
        max-width: 100%;
        overflow-wrap: anywhere;
        word-break: break-word;
        white-space: normal !important;
      }
      #notesContent mjx-container mjx-math {
        white-space: normal !important;
      }
      #notesContent mjx-container[display="true"] {
        overflow-x: auto;
        padding-bottom: 0.25rem;
      }
      .press:active {
        transform: translateY(4px);
      }
    </style>
    <script src="theme.js"></script>
  </head>

  <!-- ✅ lock page scroll; main scrolls -->
  <body
    data-step="notes"
    class="bg-background-light dark:bg-background-dark text-text-main dark:text-white font-display antialiased selection:bg-primary selection:text-white overflow-hidden"
  >
    <!-- ✅ viewport shell -->
    <div
      class="w-full max-w-md mx-auto h-[100dvh] bg-background-light dark:bg-background-dark shadow-2xl flex flex-col overflow-hidden relative"
    >
      <!-- Header -->
      <header
        class="sticky top-0 z-30 bg-background-light/95 dark:bg-background-dark/95 backdrop-blur-sm border-b border-slate-200 dark:border-slate-800 transition-colors"
      >
        <div class="flex items-center justify-between px-4 py-3">
          <div class="flex items-center gap-2">
            <!-- ✅ Back button -->
            <button
              type="button"
              onclick="(history.length > 1) ? history.back() : location.href='path.html'"
              class="press flex items-center justify-center w-10 h-10 rounded-xl hover:bg-slate-200 dark:hover:bg-slate-800 transition-colors"
              aria-label="Back"
            >
              <span class="material-symbols-outlined text-primary">arrow_back</span>
            </button>

            <h1 class="text-xl font-extrabold tracking-tight flex items-center gap-2">
              <span class="material-symbols-outlined text-primary text-2xl">menu_book</span>
              My Notebook
            </h1>
          </div>

          <button
            id="searchBtn"
            type="button"
            class="press p-2 rounded-xl hover:bg-slate-200 dark:hover:bg-slate-800 transition-colors text-text-sub dark:text-slate-300"
            aria-label="Search"
          >
            <span class="material-symbols-outlined">search</span>
          </button>
        </div>

        <!-- Course selector -->
        <div class="px-4 pb-3">
          <div class="flex h-12 w-full items-center justify-center rounded-2xl bg-slate-200 dark:bg-slate-800 p-1">
            <label
              class="flex cursor-pointer h-full grow items-center justify-center overflow-hidden rounded-xl px-2 has-[:checked]:bg-white dark:has-[:checked]:bg-surface-dark has-[:checked]:shadow-sm transition-all duration-200 group"
            >
              <span class="text-sm font-extrabold text-text-sub dark:text-slate-400 group-has-[:checked]:text-primary"
                >Calc 1</span
              >
              <input checked class="hidden" name="course_select" type="radio" value="calc-1" />
            </label>

            <label
              class="flex cursor-pointer h-full grow items-center justify-center overflow-hidden rounded-xl px-2 has-[:checked]:bg-white dark:has-[:checked]:bg-surface-dark has-[:checked]:shadow-sm transition-all duration-200 group"
            >
              <span class="text-sm font-extrabold text-text-sub dark:text-slate-400 group-has-[:checked]:text-primary"
                >Calc 2</span
              >
              <input class="hidden" name="course_select" type="radio" value="calc-2" />
            </label>

            <label
              class="flex cursor-pointer h-full grow items-center justify-center overflow-hidden rounded-xl px-2 has-[:checked]:bg-white dark:has-[:checked]:bg-surface-dark has-[:checked]:shadow-sm transition-all duration-200 group"
            >
              <span class="text-sm font-extrabold text-text-sub dark:text-slate-400 group-has-[:checked]:text-primary"
                >Calc 3</span
              >
              <input class="hidden" name="course_select" type="radio" value="calc-3" />
            </label>
          </div>
        </div>

        <div id="searchRow" class="px-4 pb-3 hidden">
          <div class="flex items-center gap-2 rounded-2xl bg-white dark:bg-surface-dark px-3 py-2 border border-slate-200 dark:border-slate-700">
            <span class="material-symbols-outlined text-text-sub">search</span>
            <input
              id="searchInput"
              type="search"
              placeholder="Search notes or examples"
              class="flex-1 bg-transparent focus:outline-none text-sm font-medium text-text-main dark:text-white"
            />
            <button id="searchClear" class="text-xs font-bold text-primary" type="button">Clear</button>
          </div>
        </div>
      </header>

      <main id="notesMain" class="flex-1 overflow-y-auto no-scrollbar p-4 space-y-4 pb-4">
        <div id="notesContent" class="space-y-4"></div>
      </main>
    </div>

    <script src="state.js"></script>
    <script src="progress.js"></script>
    <script src="content-structure.js"></script>
    <script src="content-sections.js"></script>
    <script src="content-examples.js"></script>
    <script src="content-items.js"></script>
    <script src="content-tests.js"></script>
    <script src="content.js"></script>
    <script src="engine.js"></script>
    <script src="app.js"></script>

    <script>
      let mathTypesetTries = 0;

      function shouldVibrate() {
        try {
          const prefs = JSON.parse(localStorage.getItem("fc_prefs") || "{}");
          return prefs.vibration !== false;
        } catch {
          return true;
        }
      }

      function vibrateClick() {
        if (!navigator.vibrate) return;
        if (!shouldVibrate()) return;
        navigator.vibrate(20);
      }

      function typesetMath(targets) {
        if (window.MathJax?.typesetPromise) {
          window.MathJax.typesetPromise(targets || undefined).catch(() => {});
          return;
        }
        if (mathTypesetTries < 10) {
          mathTypesetTries += 1;
          setTimeout(() => typesetMath(targets), 200);
        }
      }

      function renderNotes(query) {
        if (!window.FCContent) return;
        const courseId = localStorage.getItem("fc_course") || "calc-1";
        const course = FCContent.getCourse(courseId) || FCContent.getCourse("calc-1");
        const modules = FCContent.getCourseModules(course.id);
        const contentRoot = document.getElementById("notesContent");
        if (!contentRoot) return;
        contentRoot.innerHTML = "";

        const sectionMatches = query ? FCContent.searchSections(query, course.id) : null;
        const matchSet = sectionMatches ? new Set(sectionMatches.map((s) => s.id)) : null;

        modules.forEach((mod, modIndex) => {
          const chapters = FCContent.getModuleChapters(mod.id);
          chapters.forEach((chapter, chapterIndex) => {
            const sections = FCContent.getChapterSections(chapter.id).filter((section) =>
              matchSet ? matchSet.has(section.id) : true
            );
            if (!sections.length) return;

            const detail = document.createElement("details");
            detail.className =
              "group flex flex-col rounded-2xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-surface-dark overflow-hidden shadow-sm transition-shadow duration-200";
            detail.open = modIndex === 0 && chapterIndex === 0 && !query;

            const summary = document.createElement("summary");
            summary.className =
              "flex cursor-pointer items-center justify-between gap-4 p-4 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors list-none select-none";
            summary.innerHTML = `
              <div class="flex items-center gap-3">
                <div class="flex items-center justify-center w-8 h-8 rounded-full bg-primary/10 text-primary">
                  <span class="text-sm font-extrabold">${mod.order || modIndex + 1}</span>
                </div>
                <div class="flex flex-col">
                  <span class="text-base font-extrabold">${chapter.title}</span>
                  <span class="text-xs text-text-sub dark:text-slate-400 font-semibold">${sections.length} Topics</span>
                </div>
              </div>
              <div class="text-text-sub dark:text-slate-400 transition-transform duration-300 group-open:-rotate-180">
                <span class="material-symbols-outlined">expand_more</span>
              </div>
            `;
            detail.appendChild(summary);

            const content = document.createElement("div");
            content.className =
              "px-4 pb-4 pt-0 flex flex-col gap-4 bg-slate-50/60 dark:bg-transparent border-t border-slate-100 dark:border-slate-700";
            content.innerHTML = `<div class="h-2"></div>`;

            sections.forEach((section) => {
              const sectionHeader = document.createElement("div");
              sectionHeader.className =
                "flex items-center justify-between rounded-xl bg-white dark:bg-slate-800 p-4 border border-slate-100 dark:border-slate-700";
              sectionHeader.innerHTML = `
                <div>
                  <div class="text-sm font-extrabold text-text-sub dark:text-slate-400">Section</div>
                  <div class="text-lg font-extrabold text-slate-900 dark:text-white">${section.title}</div>
                </div>
                <button type="button" data-section-id="${section.id}" class="startLessonBtn text-primary text-sm font-bold">Go</button>
              `;
              content.appendChild(sectionHeader);

              (section.contentBlocks || []).forEach((block) => {
                const card = document.createElement("article");
                card.className =
                  "flex flex-col gap-3 rounded-xl bg-white dark:bg-slate-800 p-4 shadow-sm border border-slate-100 dark:border-slate-700";
                card.innerHTML = `
                  <div class="flex items-start justify-between">
                    <h3 class="text-primary font-extrabold text-lg">${block.title}</h3>
                  </div>
                  <p class="text-sm text-text-main dark:text-slate-300 leading-relaxed ${block.latex ? "math-text" : ""}">
                    ${block.body}
                  </p>
                `;
                content.appendChild(card);
              });

              const examples = FCContent.getSectionExamples(section.id);
              examples.forEach((ex) => {
                const exCard = document.createElement("article");
                exCard.className =
                  "flex flex-col gap-3 rounded-xl bg-white dark:bg-slate-800 p-4 shadow-sm border border-slate-100 dark:border-slate-700";
                const steps = (ex.steps || [])
                  .map(
                    (step, i) =>
                      `<li class="text-sm text-text-main dark:text-slate-300">Step ${i + 1}: ${step.text}</li>`
                  )
                  .join("");
                exCard.innerHTML = `
                  <div class="flex items-start justify-between">
                    <h3 class="text-primary font-extrabold text-lg">Example</h3>
                    <span class="text-xs font-semibold text-text-sub">${ex.difficulty}</span>
                  </div>
                  <p class="text-sm text-text-main dark:text-slate-300 leading-relaxed">${ex.prompt}</p>
                  <ol class="flex flex-col gap-1">${steps}</ol>
                  <div class="text-sm font-bold text-text-main dark:text-white">Answer: ${ex.finalAnswer}</div>
                `;
                content.appendChild(exCard);
              });
            });

            detail.appendChild(content);
            contentRoot.appendChild(detail);
          });
        });

        if (!contentRoot.children.length) {
          const empty = document.createElement("div");
          empty.className =
            "rounded-2xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-surface-dark p-6 text-center text-sm text-text-sub";
          empty.textContent = "No matches. Try a different search.";
          contentRoot.appendChild(empty);
        }

        typesetMath([contentRoot]);

        contentRoot.querySelectorAll(".startLessonBtn").forEach((btn) => {
          btn.addEventListener("click", () => {
            vibrateClick();
            const sectionId = btn.getAttribute("data-section-id");
            if (!sectionId) return;
            const session = FCEngine.createSession({
              mode: "practice",
              sectionId,
              count: 3,
              types: ["mcq", "numeric", "expression"],
              xpPerCorrect: 8,
            });
            FCEngine.saveSession(session);
            FCProgress.setCurrentSection(sectionId);
            window.location.href = "active-lesson.html";
          });
        });
      }

      // avatar hydrate from fc_state
      (function () {
        const DEFAULT_AVATAR =
          "https://github.com/juliuskalume/full-calculus/blob/main/icons/icon-192.png?raw=true";
        let s = {};
        try {
          s = JSON.parse(localStorage.getItem("fc_state") || "{}");
        } catch {
          s = {};
        }
        const url = s.avatarUrl || DEFAULT_AVATAR;
        const avatar = document.getElementById("navAvatar");
        if (avatar) avatar.style.backgroundImage = `url('${url}')`;
      })();

      const searchBtn = document.getElementById("searchBtn");
      const searchRow = document.getElementById("searchRow");
      const searchInput = document.getElementById("searchInput");
      const searchClear = document.getElementById("searchClear");

      searchBtn?.addEventListener("click", () => {
        if (!searchRow) return;
        searchRow.classList.toggle("hidden");
        if (!searchRow.classList.contains("hidden")) {
          searchInput?.focus();
        }
      });

      searchInput?.addEventListener("input", () => {
        renderNotes(searchInput.value);
      });

      searchClear?.addEventListener("click", () => {
        if (searchInput) searchInput.value = "";
        renderNotes("");
      });

      document.querySelectorAll('input[name="course_select"]').forEach((radio) => {
        radio.addEventListener("change", () => {
          vibrateClick();
          localStorage.setItem("fc_course", radio.value);
          renderNotes(searchInput?.value || "");
        });
      });

      (function syncCourseSelection() {
        const courseId = localStorage.getItem("fc_course") || "calc-1";
        const input = document.querySelector(`input[name="course_select"][value="${courseId}"]`);
        if (input) input.checked = true;
      })();

      renderNotes("");
    </script>
  </body>
</html>











